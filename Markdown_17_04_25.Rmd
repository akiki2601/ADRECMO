---
title: "ADRECMO"
author: "Jolie Bruno, Antoine Kimmoun, Kevin Duarte, Feriel Azibani, Benjamin Deniaun"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    theme: journal
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
    latex_engine: pdflatex
  word_document: null
editor_options:
  chunk_output_type: console
always_allow_html: yes
---

```{=html}
<style type="text/css">

h1.title {
  font-size: 38px;
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
    font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  text-align: center;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  text-align: center;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# markdown options depending on the output (html with R code and Word without)
output <- knitr::opts_knit$get("rmarkdown.pandoc.to")
if (output=="html") knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = TRUE, comment = "", fig.align = "center", fig.width= 17, fig.asp =0.70, out.width = "90%")
if (output=="docx") knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE, comment = "", fig.align = "center", fig.width= 17, fig.asp =0.70, out.width = "90%")
if (output=="pdf") knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE, comment = "", fig.align = "center", fig.width= 17, fig.asp =0.70, out.width = "90%")
options(max.print = .Machine$integer.max)
```

# Packages needed

```{r,include=FALSE}
library(dplyr)
library(lubridate)
library(gtsummary)
library(readr)
library(ggplot2)
library(tableone)
library(flextable)
library(sjlabelled)
library(readxl)
library(stringr)
library(tidyr)
library(purrr)
library(tableone)
library(dplyr)
library(naniar)
library(tidyr)
library(survival)
library(survminer)
library(patchwork)
library(ggpmisc)
library(cowplot)  
library(officer)
library(flextable)
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
```

# Method

This study is a monocentric, prospective, observational investigation conducted in Nancy Hospital between 10.10.2017 and 24.05.2022, enrolling 50 adult patients with refractory cardiogenic shock requiring veno-arterial extracorporeal membrane oxygenation (VA-ECMO) support (NCT03327493).

The study was carried out in accordance with the Declaration of Helsinki and approved by the local institutional ethics committee. Written informed consent was obtained from all patients or their legal representatives prior to inclusion.

Patient Population

Cardiogenic shock was defined as a systolic blood pressure (SBP) <90 mmHg or a mean arterial pressure (MAP) <65 mmHg despite adequate volume resuscitation, accompanied by signs of peripheral hypoperfusion (e.g., cold extremities, oliguria, altered mental status) and a cardiac index <2.2 L/min/m². Refractoriness was defined as a state of persistent hypoperfusion despite optimal medical management, including the use of norepinephrine and/or other vasopressors.
Eligible patients were adults (≥18 years old) affiliated with a  health insurance system. Patients were excluded if cardiogenic shock was secondary to cardiotoxic poisoning, if they were pregnant, or were under legal protective supervision (e.g., court-appointed guardianship).

Data Collection

Clinical, laboratory, and echocardiographic parameters were prospectively collected at three predefined timepoints:Day 0 (ECMO implantation), Day 3–5 (early course) and Day of ECMO weaning (ECMO explantation). Blood samples were drawn at each timepoint, immediately centrifuged, and plasma was stored at –80°C until analysis. Samples were then transferred to the XXX INSERM UMR942 laboratory (Paris, France) for centralized biomarker, cells and cytokine analysis. Quantification of adrenoreceptors (α1, α2, β1, β2, β3) on monocytes and CD4⁺ T lymphocytes was performed using flow cytometry, along with assessment of Th1/Th2 lymphocyte polarization. Cytokine concentrations in plasma, including interleukin (IL)-4, IL-12, IL-1, IL-6, IL-10, tumor necrosis factor alpha (TNF-α), and interferon gamma (IFN-γ), were measured using [XXX].

Adrenoreceptor Analysis

The expression of beta-1 (ADRB1) and beta-2 (ADRB2) adrenergic receptors on circulating T lymphocytes and monocytes was assessed via flow cytometry. Peripheral blood mononuclear cells (PBMCs) were isolated from whole blood, stained with monoclonal antibodies targeting ADRB1 and ADRB2, and analyzed using a [XXX cytometer model] according to standardized protocols. Results were expressed as the percentage of cells expressing the respective receptors.

Cytokine Quantification by ELISA

Plasma concentrations of cytokines were measured using commercially available enzyme-linked immunosorbent assay (ELISA) kits (XXX). Plasma samples, stored at –80°C until analysis, were thawed and processed in duplicate according to the manufacturer’s protocol. Optical density was measured using a microplate reader, and cytokine levels were interpolated from standard curves. 

ECMO Weaning Protocol

A standardized weaning protocol was applied to all patients prior to ECMO explantation. At a constant mean arterial pressure (MAP) between 65 and 75 mmHg, cardiac output was assessed by transthoracic echocardiography at two predefined timepoints: 1. Baseline under full support (ECLS flow at 3.0 L/min) and 2. Low-flow test after 45 minutes of reduced ECMO flow (1.5 L/min).
Measurements included velocity time integral (VTI) at the left ventricular outflow tract and left ventricular ejection fraction. Changes in norepinephrine and dobutamin dosage during this period were also documented. The decision to explant ECMO was based on clinical tolerance, hemodynamic stability and echocardiographic parameters during the weaning trial.

# Fonctions

```{r,include=FALSE}

# Dummy function to avoid errors
linearity_test <- function(t2event = NULL, event = "death", var = "copper", adj = c("age", "sex"), data = data, weight = "wt")


# Ora carica la funzione dal file
source("FUNCTIONS/Examples - RCS effect + interaction cont x factor + check normality 181224.R")

```

# DATA Load

```{r,include=FALSE}

## Add Lynfo

fichier <- "DATA/df_i_stabilized.xlsx"
feuilles <- excel_sheets(fichier)
data_list <- lapply(feuilles, function(feuille) {
  read_excel(fichier, sheet = feuille)
})


ADR1 <- data_list[[1]] %>%
  select( "Patient","Jour", "%Total")%>%
  filter(!is.na(`%Total`))%>%
  rename(value = `%Total`)%>%
  mutate(ID =str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2"))%>%
  pivot_wider(
    names_from = "Jour",
     names_prefix = "ADR1_",
    values_from = "value",
    values_fn = mean,  # Moyenne des doublons
    values_fill = NA
  )%>%
  mutate (`ADR1_J3-5` = case_when(is.na(`ADR1_J3-5`)&!is.na(ADR1_J5)~ADR1_J5,
                             T~`ADR1_J3-5`),
          ADR1_JS = case_when(is.na(ADR1_JS)&!is.na(`ADR1_J3-5-S`)~`ADR1_J3-5-S`,
                             T~ADR1_JS))%>%
  rename(ADR1_J3_J5=`ADR1_J3-5`)%>%
  
  dplyr::select(ID,
                ADR1_J0,
                ADR1_J3_J5,
                ADR1_JS)


ADR2 <- data_list[[2]] %>%
  select( "Patient","Jour", "%Total")%>%
  filter(!is.na(`%Total`))%>%
  rename(value = `%Total`)%>%
  mutate(ID = str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2"))%>%
  pivot_wider(
    names_from = "Jour",
    values_from = "value",
     names_prefix = "ADR2_" ,
    values_fn = mean,  # Moyenne des doublons
    values_fill = NA
  )%>%
  mutate (
          ADR2_JS = case_when(is.na(ADR2_JS)&!is.na(`ADR2_J3-5-S`)~`ADR2_J3-5-S`,
                             T~ADR2_JS))%>%
  rename(ADR2_J3_J5=`ADR2_J3-5`)%>%
  dplyr::select(ID,
                ADR2_J0,
                ADR2_J3_J5,
                ADR2_JS)

##Add Monocytes

fichier_mono <- "DATA/monocytes.xlsx"
feuilles_mono <- excel_sheets(fichier_mono)
data_mono <- lapply(feuilles_mono, function(feuille_mono) {
  read_excel(fichier_mono, sheet = feuille_mono)
})


ADR1_mono <- data_mono[[1]] %>%
  select("Patient", "Jour", "%Total") %>%
  filter(!is.na(`%Total`)) %>%
  rename(value = `%Total`) %>%
  mutate(
    # Create clean ID and normalize 'Jour'
    ID = str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2"),
    Jour = str_to_upper(str_trim(Jour))
  ) %>%
  # Reshape from long to wide format
  pivot_wider(
    names_from = "Jour",
    names_prefix = "ADR1m_",
    values_from = "value",
    values_fn = mean,
    values_fill = NA
  ) %>%
  mutate(
    ADR1m_J3_J5 = case_when(
      !is.na(`ADR1m_J3-5`) ~ `ADR1m_J3-5`,
      is.na(`ADR1m_J3-5`) & !is.na(ADR1m_JS) ~ ADR1m_JS,
      TRUE ~ NA_real_
    )
  ) %>%
  # Final variable renaming and selection
  rename(
    ADR1m_J0 = `ADR1m_J0`
  ) %>%
  select(ID, ADR1m_J0, ADR1m_J3_J5, ADR1m_JS)


ADR2_mono <- data_mono[[2]] %>%
  select("Patient", "Jour", "%Total") %>%
  filter(!is.na(`%Total`)) %>%
  rename(value = `%Total`) %>%
  mutate(
    # Create clean ID and normalize 'Jour'
    ID = str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2"),
    Jour = str_to_upper(str_trim(Jour))
  ) %>%
  # Reshape from long to wide format
  pivot_wider(
    names_from = "Jour",
    names_prefix = "ADR2m_",
    values_from = "value",
    values_fn = mean,
    values_fill = NA
  ) %>%
  # Create combined J3_J5 timepoint using fallback logic
  mutate(
    ADR2m_J3_J5 = case_when(
      !is.na(`ADR2m_J3-5`) ~ `ADR2m_J3-5`,
      is.na(`ADR2m_J3-5`) & !is.na(ADR2m_JS) ~ ADR2m_JS,
      TRUE ~ NA_real_
    )
  ) %>%
  # Final variable renaming and selection
  rename(
    ADR2m_J0 = `ADR2m_J0`
  ) %>%
  select(ID, ADR2m_J0, ADR2m_J3_J5, ADR2m_JS)



DATA <- read_delim("DATA/ADRECMO_DATA.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)%>%
  mutate(nom = str_to_upper(nom),
         prenom =str_to_upper(prenom),
         ID = paste0(numero,"-",nom,prenom))
        
df_list <- lst(DATA, ADR1, ADR2, ADR1_mono, ADR2_mono)

df <- reduce(df_list, left_join, by = "ID") %>%
  filter(ID != "12-NANA")

```

# DATA Management

```{r,include=FALSE}


var.cat <- c("Gender", "HTN", "DM", "Immunodepression", "CKD", "Neurologic_deficit", "Chronic_respiratory_disease", "HF", "Cardiac_arrest_before_canul", "IABP_D0", "Intubation", "EER_D0", "Outcome", "Betablocker", "Alphablocker", "Levosimendan", "Death")

var.cont <- c("Age", "BMI", "PAS_D0", "PAD_D0", "PAM_D0", "Pulsepressure_D0", "HR_D0", "Temp_D0", "Preecmo_tte_ef", "Preecmo_tte_vtiao", "Preecmo_tte_diam_LV", "Preecmo_tte_tapse", "Preecmo_tte_vmax_s_mit_lat_LV", "NADcum_D0", "DOBUcum_D0", "pH_D0", "Sao2_D0", "Paco2_D0", "Lact_D0", "Hco3_D0", "Creat_D0", "Urea_D0", "ALAT_D0", "ASAT_D0", "Bili_D0", "PT_D0", "Tropo_i_hs_D0", "Ntprobnp_D0", "DPP3_D0", "Plq_D0", "Lenght_eer", "Lenght_vm", "Time_hosp", "Time_ecmo")

var.tot <- c(var.cat, var.cont)

df <- df %>%
  mutate(
    # Basic formatting
    Temp_D0 = round(Temp_D0, 1),
    Age = as.numeric(Age),
    Gender = case_when(
      Gender == 0 ~ "Men",
      Gender == 1 ~ "Women",
      TRUE ~ as.character(Gender)
    ),

    # Outcome recoding
    Outcome = case_when(
      Outcome == 1 ~ "ECMO Weaning",
      Outcome == 2 ~ "Bridge to Transplant",
      Outcome == 3 ~ "Bridge to LVAD",
      Outcome == 4 ~ "Death",
      TRUE ~ as.character(Outcome)
    ),
    
    Pulsepressure_D0 = PAS_D0 - PAD_D0,
    
    Outcome_censored = as.numeric(case_when(
      Outcome == "Death" ~ "1",
      Outcome %in% c("ECMO Weaning", "Bridge to Transplant", "Bridge to LVAD") ~ "0"
    )),

    outcome_date = str_replace_all(outcome_date, "\\.", "/"),
    icu_admiss_date = str_replace_all(icu_admiss_date, "\\.", "/"),
    icu_discharge_date = str_replace_all(icu_discharge_date, "\\.", "/"),

    outcome_date = dmy(outcome_date),
    icu_admiss_date = dmy(icu_admiss_date),
    icu_discharge_date = dmy(icu_discharge_date),
    date_levo = dmy(date_levo),
    ecmo_start_date = dmy(ecmo_start_date),
    ecmo_stop_date = dmy(ecmo_stop_date),

    diff_days = time_length(interval(icu_admiss_date, outcome_date), "days"),
    Time_hosp = time_length(interval(icu_admiss_date, icu_discharge_date), "days"),
    as.numeric(icu_discharge_date - icu_admiss_date),
    Time_ecmo = time_length(interval(ecmo_start_date, ecmo_stop_date), "days"),
    Time_levo = time_length(interval(ecmo_start_date, date_levo), "days"),

    diff_days_J28 = case_when(
      diff_days > 28 ~ 28,
      TRUE ~ diff_days
    ),

    Outcome_censored_28 = case_when(
      diff_days > 28 & Outcome_censored == 1 ~ 0,
      TRUE ~ Outcome_censored
    ),

    ADR1_D0_median = case_when(
      ADR1_D0 > median(ADR1_D0, na.rm = TRUE) ~ "High",
      ADR1_D0 <= median(ADR1_D0, na.rm = TRUE) ~ "Low"
    ),

    ADR2_D0_median = case_when(
      ADR2_D0 > median(ADR2_D0, na.rm = TRUE) ~ "High",
      ADR2_D0 <= median(ADR2_D0, na.rm = TRUE) ~ "Low"
    ),
    
    ADR1m_D0_median = case_when(
      ADR1m_J0 > median(ADR1m_J0, na.rm = TRUE) ~ "High",
      ADR1m_J0 <= median(ADR1m_J0, na.rm = TRUE) ~ "Low",
      TRUE ~ NA_character_
    ),
    ADR2m_D0_median = case_when(
      ADR2m_J0 > median(ADR2m_J0, na.rm = TRUE) ~ "High",
      ADR2m_J0 <= median(ADR2m_J0, na.rm = TRUE) ~ "Low",
      TRUE ~ NA_character_
    ),

    Betablocker = case_when(
      Betablocker == 1 ~ "YES",
      Betablocker == 0 ~ "NO"
    ),

    dose_tot_dobu_yes_no = droplevels(as.factor(case_when(
      dose_tot_dobu > 0 ~ "YES",
      dose_tot_dobu == 0 ~ "NO"
    ))),

    levo_in_icu = case_when(
      Levosimendan == 1 & Time_levo >= 0 ~ "Yes",  
      Levosimendan == 1 & Time_levo < 0 ~ "No",
      Levosimendan == 0 ~ "No"
    ),

    Levosimendan = case_when(
      Levosimendan == 1 ~ "YES",
      Levosimendan == 0 ~ "NO",
      TRUE ~ NA_character_ 
    )
  )

```

# TABLE 1: description of baseline characteristics of the population at inclusion

```{r,include=FALSE}

T1 <- df %>%
  dplyr::select(all_of(var.tot))%>%
  mutate(across(all_of(var.cont), as.numeric), 
         across(all_of(var.cat), as.factor))

## Table 1 standard

table1 <- CreateTableOne(vars = var.tot, factorVars = var.cat, data =T1) # sans groupe de strata

table1 <- print(table1, nonnormal =var.cont)

table1_df <- as.data.frame(print(table1, nonnormal = var.cont, showAllLevels = TRUE))
table1_df$Variables <- row.names(table1_df)

row.names(table1_df)<-NULL
table1_df <- table1_df[, c(2,1)]

T1_n <- T1%>%
  summarise(across(everything(), ~ sum(is.na(.))))%>%
  pivot_longer(cols= everything(),
    values_to = "n_missing",
    names_to = "ID")%>%
  mutate(n_missing = paste0(n_missing,"/50"),
         ID = trimws(ID))

table1_df1 <- table1_df %>%
  mutate(ID = sub("\\(median \\[IQR\\]\\)|= 1 \\(\\%\\)|= Women \\(\\%\\)|\\(\\%\\)", "",Variables),
         ID = trimws(ID))

table_1_vf <- left_join(table1_df1,T1_n, by="ID")%>%
  select(Variables,n_missing,Overall)%>%
  mutate(n_missing = replace_na(n_missing,""))

table_1_vf <- left_join(table1_df1, T1_n, by = "ID") %>%
  mutate(N = 50 - as.numeric(sub("/50", "", replace_na(n_missing, "0")))) %>%  # Calcola N
  select(Variables, N, Overall)  

print(table_1_vf)
table_1_vf <- table_1_vf%>%
mutate(Variables= str_remove(Variables, " \\(median \\[IQR\\]\\)"))

traduction <- c(
  "n" = "n",
  "Gender = Women (%)" = "Gender = Female (%)",
  "HTN = 1 (%)" = "Hypertension (%)",
  "DM = 1 (%)" = "Diabetes Mellitus (%)",
  "Immunodepression = 1 (%)" = "Immunosuppression (%)",
  "CKD = 1 (%)" = "Chronic Kidney Disease (%)",
  "Neurologic_deficit = 1 (%)" = "Neurological Deficit (%)",
  "Chronic_respiratory_disease = 1 (%)" = "Chronic Respiratory Disease (%)",
  "HF = 1 (%)" = "Heart Failure (%)",
  "Cardiac_arrest_before_canul = 1 (%)" = "Cardiac Arrest Before Cannulation (%)",
  "IABP_D0 = 1 (%)" = "Intra-Aortic Balloon Pump (%)",
  "Intubation = 1 (%)" = "Intubation (%)",
  "EER_D0 = 1 (%)" = "Renal Replacement Therapy (%)",
  "Outcome (%)" = "Outcome (%)",
  "   Bridge to LVAD" = "Bridge to LVAD",
  "   Bridge to Transplant" = "Bridge to Transplant",
  "   Death" = "Death",
  "   ECMO Weaning" = "ECMO Weaning",
  "Betablocker = YES (%)" = "Beta-blocker (%)",
  "Alphablocker = 1 (%)" = "Alpha-blocker (%)",
  "Levosimendan = 1 (%)" = "Levosimendan (%)",
  "Death = 1 (%)" = "Death (%)",
  "Age" = "Age (years)",
  "BMI" = "Body Mass Index (kg/m²)",
  "PAS_D0" = "Systolic Blood Pressure (mmHg)",
  "PAD_D0" = "Diastolic Blood Pressure (mmHg)",
  "PAM_D0" = "Mean Arterial Pressure (mmHg)",
  "Pulsepressure_D0" = "Pulse Pressure (mmHg)",
  "HR_D0" = "Heart Rate (bpm)",
  "Temp_D0" = "Temperature (°C)",
  "Preecmo_tte_ef" = "Pre-ECMO Ejection Fraction (%)",
  "Preecmo_tte_vtiao" = "Pre-ECMO Aortic Velocity Time Integral (cm)",
  "Preecmo_tte_diam_LV" = "Pre-ECMO Left Ventricular Diameter (mm)",
  "Preecmo_tte_tapse" = "Pre-ECMO TAPSE (mm)",
  "Preecmo_tte_vmax_s_mit_lat_LV" = "Pre-ECMO Mitral Lateral Velocity (cm/s)",
  "NADcum_D0" = "Cumulative Norepinephrine Dose (mg)",
  "DOBUcum_D0" = "Cumulative Dobutamine Dose (mg)",
  "pH_D0" = "pH",
  "Sao2_D0" = "Oxygen Saturation (%)",
  "Paco2_D0" = "PaCO2 (mmHg)",
  "Lact_D0" = "Lactate (mmol/L)",
  "Hco3_D0" = "Bicarbonate (mmol/L)",
  "Creat_D0" = "Creatinine (µmol/L)",
  "Urea_D0" = "Urea (mg/dL)",
  "ALAT_D0" = "ALT (IU/L)",
  "ASAT_D0" = "AST (IU/L)",
  "Bili_D0" = "Bilirubin (mg/dL)",
  "PT_D0" = "Prothrombin Time (s)",
  "Tropo_i_hs_D0" = "High Sensitivity Troponin I (ng/L)",
  "Ntprobnp_D0" = "NT-proBNP (pg/mL)",
  "DPP3_D0" = "DPP3 (ng/mL)",
  "Plq_D0" = "Platelet Count (10⁹/L)",
  "Lenght_eer" = "Duration of Renal Replacement Therapy (days)",
  "Lenght_vm" = "Duration of Mechanical Ventilation (days)",
  "Time_hosp" = "Hospital Length of Stay (days)",
  "Time_ecmo" = "ECMO Duration (days)"
)

table_1_vf <- table_1_vf %>%
  mutate(Variables = recode(Variables, !!!traduction))

table1 <- flextable(as.data.frame(table_1_vf)) %>% autofit() %>%
      set_caption("Table 1: Baseline characteristics at inclusion") %>% 
     align(j = c(2:3), align = "center", part = "all")

```

```{r, include=FALSE, eval=F}
doc <- read_docx() %>%
  body_add_flextable(table1)

print(doc, target = "TABLES/Table1_def.docx")
```


```{r}
table1
```

Statistical analysis

Baseline clinical, demographic and hemodynamic characteristics were summarized for the overall study population (n = 50). One patient was excluded from the analysis due to being under legal guardianship. Categorical variables were reported as counts and percentages, while continuous variables were expressed as medians and interquartile ranges (IQR). The normality of continuous variables was assessed visually using histograms.

# Check for normality

```{r,include=FALSE, eval=FALSE}
for (var in var.cont) {
  if (var %in% colnames(T1)) {
    print(
      ggplot(T1, aes_string(var)) +
        geom_histogram(bins = 15, fill = "blue", alpha = 0.5) +
        ggtitle(paste("Distribuzione di", var))
    )
  } else {
    message(paste("❌ Variabile", var, "non trovata in T1"))
  }
}
```

# Table 2a with hemodynamic parameters at weaning day

```{r, include=FALSE}

## General information at weaning day

df_long <- df %>%
  select(
    ID,
    jsev_ecmo_debit,
    jsev_dobu_cum,
    jsev_NAd_cum,
    jsev_pam,
    jsev_freq,
    jsev_ett_fevg,
    jsev_ett_vmax_s_mit_lat_vg,
    jsev_lact
  ) %>%
  rename(
    `ECMO flow (l)` = jsev_ecmo_debit,
    `Dobutamine cumulative (mg)` = jsev_dobu_cum,
    `Noradrenaline cumulative (mg)` = jsev_NAd_cum,
    `MAP_baseline (mmHg)` = jsev_pam,
    `HR (bpm)` = jsev_freq,
    `FEVG (%)` = jsev_ett_fevg,
    `Mitral S' (cm/s)` = jsev_ett_vmax_s_mit_lat_vg,
    `Lactate (mmol/L)` = jsev_lact
  ) %>%
  pivot_longer(
    cols = -ID,
    names_to = "Parameter",
    values_to = "Value"
  )

# Define desired parameter order
custom_order <- c(
  "ECMO flow (l)",
  "Dobutamine cumulative (mg)",
  "Noradrenaline cumulative (mg)",
  "MAP_baseline (mmHg)",
  "HR (bpm)",
  "FEVG (%)",
  "Mitral S' (cm/s)",
  "Lactate (mmol/L)"
)

# Apply ordering after summarising
table2a <- df_long %>%
  group_by(Parameter) %>%
  summarise(
    n= sum(!is.na(Value)),
    Median = round(median(Value, na.rm = TRUE), 1),
    Q1 = round(quantile(Value, 0.25, na.rm = TRUE), 1),
    Q3 = round(quantile(Value, 0.75, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(`Median [IQR]` = paste0(Median, " [", Q1, "–", Q3, "], n=", n)) %>%
  select(Parameter, `Median [IQR]`) %>%
  slice(match(custom_order, Parameter))  # Reorder according to custom_order

```

```{r}
table2a
```

# Table 2b  hemodynamic parameters during the weaning test

```{r}

# Create new variables for flow condition and unify variable names
df_long <- df %>%
  select(
    ID,
    jsev_epr_sev_t0_3l_itv,
    jsev_epr_sev_t0_3l_pam,
    jsev_epr_sev_t0_3l_NAd,
    `jsev_epr_sev_t1_1,5l_itv`,
    `jsev_epr_sev_t1_1,5l_pam`,
    `jsev_epr_sev_t1_1,5l_NAd`,
    Weight,
  ) %>%
  mutate(jsev_epr_sev_t0_3l_NAd_w = jsev_epr_sev_t0_3l_NAd/Weight,
         `jsev_epr_sev_t1_1,5l_NAd_w` = `jsev_epr_sev_t1_1,5l_NAd`/Weight)%>%
  rename(
    `VTI (cm)` = jsev_epr_sev_t0_3l_itv,
    `MAP (mmHg)` = jsev_epr_sev_t0_3l_pam,
    `Noradrenalin (µg/kg/h)` = jsev_epr_sev_t0_3l_NAd_w,
    `VTI_1.5L (cm)` = `jsev_epr_sev_t1_1,5l_itv`,
    `MAP_1.5L (mmHg)` = `jsev_epr_sev_t1_1,5l_pam`,
    `Noradrenalin_1.5L (µg/kg/h)` = `jsev_epr_sev_t1_1,5l_NAd_w`
  ) %>%
  pivot_longer(
    cols = -c(ID,jsev_epr_sev_t0_3l_NAd,`jsev_epr_sev_t1_1,5l_NAd`,Weight),
    names_to = "Parameter_raw",
    values_to = "Value"
  ) %>%
  mutate(
    Value = as.numeric(Value),
    Condition = case_when(
      str_detect(Parameter_raw, "1.5L") ~ "1.5L",
      TRUE ~ "3L"
    ),
    Condition = factor(Condition, levels = c("3L", "1.5L")),
    Parameter = str_replace(Parameter_raw, "_1.5L", "")
  )

df_long%>%
  group_by(Parameter,Condition)%>%
 summarise(n = sum(!is.na(Value)), .groups = "drop")

wilcox.test(Value ~ Condition,
            data = df_long %>% filter(Parameter == "VTI (cm)"))#NS

# No significant diference between ITV 3L and 1.5 L (p=0.5).


# Create summary table

table2b <- df_long %>%
  group_by(Parameter, Condition) %>%
  summarise(
    n = sum(!is.na(Value)),
    Median = round(median(Value, na.rm = TRUE), 2),
    Q1 = round(quantile(Value, 0.25, na.rm = TRUE), 2),
    Q3 = round(quantile(Value, 0.75, na.rm = TRUE), 2),
    .groups = "drop"
  ) %>%
  mutate(
    Value_IQR = paste0(Median, " [", Q1, "–", Q3, "]; n=", n)
  ) %>%
  select(Parameter, Condition, Value_IQR) %>%
  pivot_wider(names_from = Condition, values_from = Value_IQR)
```


```{r}
table2b
```

# Figure 1: Association between ADRB expressions and outcomes

```{r,include=FALSE}

F1 <- df %>%
  select(ID,ADR1_J0, ADR1_J3_J5, ADR1_JS, Outcome)%>%
  mutate(Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",T~Outcome), levels=c("ECMO Weaning","Bridge to transplant or LVAD","Death")))%>%
  pivot_longer(
    cols = c(ADR1_J0, ADR1_J3_J5, ADR1_JS), 
    names_to = "ADR1_time", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR1_time=="ADR1_J0"~1,
                          ADR1_time=="ADR1_J3_J5"~2,
                          ADR1_time=="ADR1_JS"~3)),
         value_log = log10(value))

count_data <- F1 %>%
  filter(!is.na(value))%>%
  group_by(ADR1_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop")%>%
  filter(!is.na(Outcomes))


# ===========================
# Modélisation
# ===========================

# Modèle avec interaction
mod1 <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 + time | ID),
  data = F1
)


# Résumé du modèle
summary(mod1)

# Modèle sans interaction (modèle réduit)
mod_no_interaction <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 + time | ID),
  data = F1
)

# Comparaison des modèles (test de l'interaction)
interact <- anova(mod_no_interaction, mod1)
# Interprétation : p = 0.58 → interaction non significative

# ===========================
# Tests des effets fixes
# ===========================

# ANOVA avec approximation de Kenward-Roger pour les p-values
a <- anova(mod_no_interaction, ddf = "Kenward-Roger")
print(a)

# ===========================
# Vérification des hypothèses
# ===========================

# 1. Diagrammes de diagnostic généraux
plot(mod1)  # résidus vs prédictions par groupe

# 2. Résidus vs valeurs ajustées (homoscédasticité)
plot(fitted(mod1), residuals(mod1),
     xlab = "Valeurs ajustées", ylab = "Résidus",
     main = "Résidus vs ajustés")

# 3. Normalité des résidus
qqnorm(residuals(mod1))
qqline(residuals(mod1), col = "blue")

# 4. Autocorrélation des résidus (si données longitudinales)
acf(residuals(mod1), main = "ACF des résidus")

# 5. Normalité des pentes aléatoires (effets aléatoires sur time)
qqnorm(ranef(mod1)$ID[, "time"],
       main = "QQ-plot des pentes aléatoires (time)")
qqline(ranef(mod1)$ID[, "time"], col = "blue")

#extrait P values
annot_pvals <- data.frame(
  ADR1_time = "ADR1_J0",
  value_log = max(F1$value_log, na.rm = TRUE) * 1.1,
  label = "p[time] == 0.024 * '\n' * p[outcomes] == 0.066"
)

# ===========================
# Figure
# ===========================
Figure_1 <- ggplot(F1, aes(x = ADR1_time, y = value_log, fill = Outcomes)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +  
  scale_y_log10() +  
  labs(
    title = "Association between ADRB1 and outcomes",
    x = "times of measurement",
    y = "Percentage of T4 lymphocyte expressing ADRB1\n (log 10 scale)",
  ) +
  geom_text(data = count_data, aes(x = ADR1_time, y =- min(F1$value_log, na.rm = TRUE) *0.1, 
                                   label = paste0("n=", n), group = Outcomes), 
            position = position_dodge(0.7), size = 4, vjust = 1)+
    scale_x_discrete(labels = c("ADR1_J0" = "implantation", "ADR1_J3_J5" = "day 3 to 5", "ADR1_JS" = "explantation")) +
  theme(legend.position = "none")+ 
  annotate(
    "text",
    x = 1,  # position sur l’axe x : 1 = "ADR1_J0"
    y = max(F1$value_log, na.rm = TRUE) * 1.1,  # position en haut du graphique
    label = "p[time] == 0.024*';'~p[outcomes] == 0.066",
    parse = TRUE,
    size = 4,
    hjust = 0
  )

print(Figure_1)

#####################
## ADRB2 
#####################


F1_1 <- df %>%
  select(ID,ADR2_J0, ADR2_J3_J5, ADR2_JS, Outcome)%>%
  mutate(Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",T~Outcome), levels=c("ECMO Weaning","Bridge to transplant or LVAD","Death")))%>%
  pivot_longer(
    cols = c(ADR2_J0, ADR2_J3_J5, ADR2_JS), 
    names_to = "ADR2_time", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR2_time=="ADR2_J0"~1,
                          ADR2_time=="ADR2_J3_J5"~2,
                          ADR2_time=="ADR2_JS"~3)),
         value_log = log10(value))


count_data <- F1_1 %>%
  filter(!is.na(value))%>%
  group_by(ADR2_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop")%>%
  filter(!is.na(Outcomes))

# ===========================
# Modélisation
# ===========================

# Modèle avec interaction
mod1 <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 + time | ID),
  data = F1_1
)

# Résumé du modèle
summary(mod1)

# Modèle sans interaction (modèle réduit)
mod_no_interaction <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 + time | ID),
  data = F1_1
)

# Comparaison des modèles (test de l'interaction)
interact <- anova(mod_no_interaction, mod1)
# Interprétation : p = 0.58 → interaction non significative

# ===========================
# Tests des effets fixes
# ===========================

# ANOVA avec approximation de Kenward-Roger pour les p-values
a <- anova(mod_no_interaction, ddf = "Kenward-Roger")
print(a)

# ===========================
# Vérification des hypothèses
# ===========================

# 1. Diagrammes de diagnostic généraux
plot(mod1)  # résidus vs prédictions par groupe

# 2. Résidus vs valeurs ajustées (homoscédasticité)
plot(fitted(mod1), residuals(mod1),
     xlab = "Valeurs ajustées", ylab = "Résidus",
     main = "Résidus vs ajustés")

# 3. Normalité des résidus
qqnorm(residuals(mod1))
qqline(residuals(mod1), col = "blue")

# 4. Autocorrélation des résidus (si données longitudinales)
acf(residuals(mod1), main = "ACF des résidus")

# 5. Normalité des pentes aléatoires (effets aléatoires sur time)
qqnorm(ranef(mod1)$ID[, "time"],
       main = "QQ-plot des pentes aléatoires (time)")
qqline(ranef(mod1)$ID[, "time"], col = "blue")

#extrait P values
annot_pvals <- data.frame(
  ADR2_time = "ADR2_J0",
  value_log = max(F1_1$value_log, na.rm = TRUE) * 1.1,
  label = "p[time] == 0.07 * '\n' * p[outcomes] == 0.05"
)

Figure_1.1 <- ggplot(F1_1, aes(x = ADR2_time, y = value_log, fill = Outcomes)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +  
  scale_y_log10() +  
  labs(
    title = "Association between ADRB2 and outcomes",
    x = "times of measurement",
    y = "Percentage of T4 lymphocyte expressing ADRB2\n (log 10 scale)",
  ) +
  geom_text(data = count_data, aes(x = ADR2_time, y = -min(F1_1$value_log, na.rm = TRUE) * 0.01, 
                                   label = paste0("n=", n), group = Outcomes), 
            position = position_dodge(0.7), size = 4, vjust = 1)+
      scale_x_discrete(labels = c("ADR2_J0" = "implantation", "ADR2_J3_J5" = "day 3 to 5", "ADR2_JS" = "explantation"))+
    annotate(
    "text",
    x = 1,  # position sur l’axe x : 1 = "ADR1_J0"
    y = max(F1_1$value_log, na.rm = TRUE) * 1.1,  # position en haut du graphique
    label = "p[time] == 0.07*';'~p[outcomes] == 0.05",
    parse = TRUE,
    size = 4,
    hjust = 0
  )

print(Figure_1.1)

Fig_1 <- Figure_1 #+ theme(plot.title = element_blank())
Fig_1.1 <- Figure_1.1 #+ theme(plot.title = element_blank())

Figure1_tot <- Fig_1 + Fig_1.1 +
  plot_annotation(title = "Association between percentage of T4 lymphocyte expressing ADRB and Outcome")
print(Figure1_tot)

```

```{r}
Figure1_tot
```

# Figure 1m: Association between ADRB (monocytes) and outcomes

```{r,include=FALSE}

# Prepare data
F1m <- df %>%
  select(ID, ADR1m_J0, ADR1m_J3_J5, ADR1m_JS, Outcome) %>%
  mutate(Outcomes = factor(case_when(
    Outcome == "Bridge to LVAD" | Outcome == "Bridge to Transplant" ~ "Bridge to transplant or LVAD",
    TRUE ~ Outcome
  ), levels = c("ECMO Weaning", "Bridge to transplant or LVAD", "Death"))) %>%
  pivot_longer(
    cols = c(ADR1m_J0, ADR1m_J3_J5, ADR1m_JS), 
    names_to = "ADR1_time", 
    values_to = "value"
  ) %>%
  mutate(
    time = case_when(
      ADR1_time == "ADR1m_J0" ~ 1,
      ADR1_time == "ADR1m_J3_J5" ~ 2,
      ADR1_time == "ADR1m_JS" ~ 3
    )
  ) %>%
  filter(!is.na(value), is.finite(value))

F1m <- F1m %>%
  mutate(value_log = log10(value)) %>%
  filter(!is.na(value_log), is.finite(value_log))  # per sicurezza


# Count data for annotation
count_data_m <- F1m %>%
  filter(!is.na(value)) %>%
  group_by(ADR1_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(!is.na(Outcomes))

# ===========================
# Mixed effects model
# ===========================
# Modello completo con interazione
mod1_m <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 + time | ID),
  data = F1m
)

# Modello ridotto senza interazione
mod_no_interaction_m <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 + time | ID),
  data = F1m
)

# Confronto tra modelli: test dell'interazione
interact_m <- anova(mod_no_interaction_m, mod1_m)
print(interact_m)  # p per l'interazione

# ANOVA per effetti fissi (senza interazione)
a_m <- anova(mod_no_interaction_m, ddf = "Kenward-Roger")
print(a_m)         # p per time e outcome

# ===========================
# Diagnostic plots
# ===========================
# 1. Residual diagnostic plots
plot(mod1_m)

# 2. Residuals vs Fitted
plot(fitted(mod1_m), residuals(mod1_m),
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")

# 3. Normality of residuals
qqnorm(residuals(mod1_m))
qqline(residuals(mod1_m), col = "blue")

# 4. Autocorrelation of residuals
acf(residuals(mod1_m), main = "ACF of residuals")

# 5. Normality of random intercepts (optional)
qqnorm(ranef(mod1_m)$ID[, "(Intercept)"],
       main = "QQ plot of random intercepts (ID)")
qqline(ranef(mod1_m)$ID[, "(Intercept)"], col = "blue")

# ===========================
# Figure
# ===========================
Figure_1m <- ggplot(F1m, aes(
    x = ADR1_time,
    y = value,
    fill = Outcomes,
    group = interaction(ADR1_time, Outcomes)  # forza 3 box per timepoint
)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +
  scale_y_log10() +
  labs(
    title = "Association between ADRB1 expression in monocytes and outcomes",
    x = "Time of measurement",
    y = "Percentage of monocytes expressing ADRB1"
  ) +
  geom_text(data = count_data_m, aes(
    x = ADR1_time,
    y = -min(F1m$value, na.rm = TRUE) * 0.1,
    label = paste0("n=", n),
    group = interaction(ADR1_time, Outcomes)
  ),
  position = position_dodge(0.7),
  size = 4,
  vjust = 1) +
  scale_x_discrete(labels = c(
    "ADR1m_J0" = "implantation",
    "ADR1m_J3_J5" = "day 3 to 5",
    "ADR1m_JS" = "explantation"
  )) +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1,
    y = max(F1m$value, na.rm = TRUE) * 1.1,
    label = "p[time] == 0.955*';'~p[outcomes] == 0.649",
    parse = TRUE,
    size = 4,
    hjust = 0
  )

print(Figure_1m)

#####################
## ADRB2 (monocytes)
#####################

# ==========================
# Prepare data (non log)
# ==========================
F1m_2 <- df %>%
  select(ID, ADR2m_J0, ADR2m_J3_J5, ADR2m_JS, Outcome) %>%
  mutate(
    Outcomes = factor(case_when(
      Outcome %in% c("Bridge to LVAD", "Bridge to Transplant") ~ "Bridge to transplant or LVAD",
      TRUE ~ Outcome
    ), levels = c("ECMO Weaning", "Bridge to transplant or LVAD", "Death"))
  ) %>%
  pivot_longer(
    cols = c(ADR2m_J0, ADR2m_J3_J5, ADR2m_JS),
    names_to = "ADR2_time",
    values_to = "value"
  ) %>%
  mutate(
    time = case_when(
      ADR2_time == "ADR2m_J0" ~ 1,
      ADR2_time == "ADR2m_J3_J5" ~ 2,
      ADR2_time == "ADR2m_JS" ~ 3
    )
  ) %>%
  filter(!is.na(value), is.finite(value))

F1m_2 <- F1m_2 %>%
  mutate(value_log = log10(value)) %>%
  filter(!is.na(value_log), is.finite(value_log))

# ==========================
# Count available data
# ==========================
count_data_m2 <- F1m_2 %>%
  group_by(ADR2_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop")

# ==========================
# Mixed effects model (simplified)
# ==========================
mod1_m2 <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 + time | ID),
  data = F1m_2
)


mod_no_interaction_m2 <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 + time | ID),
  data = F1m_2
)

# Test interaction
interact_m2 <- anova(mod_no_interaction_m2, mod1_m2)

# Fixed effect ANOVA (no interaction)
a_m2 <- anova(mod_no_interaction_m2, ddf = "Kenward-Roger")

# Extract p-values
p_time <- a_m2["time", "Pr(>F)"]
p_outcomes <- a_m2["Outcomes", "Pr(>F)"]

annot_label <- paste0(
  "p[time] == ", format(round(p_time, 3), nsmall = 3),
  "*';'*~p[outcomes] == ", format(round(p_outcomes, 3), nsmall = 3)
)

# ==========================
# Diagnostics
# ==========================
plot(mod1_m2)
plot(fitted(mod1_m2), residuals(mod1_m2),
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")

qqnorm(residuals(mod1_m2))
qqline(residuals(mod1_m2), col = "blue")

acf(residuals(mod1_m2), main = "ACF of residuals")

qqnorm(ranef(mod1_m2)$ID[, "(Intercept)"], main = "QQ plot of random intercepts")
qqline(ranef(mod1_m2)$ID[, "(Intercept)"], col = "blue")

# ==========================
# Final Plot
# ==========================
Figure_1m_2 <- ggplot(F1m_2 %>% filter(value > 0), aes(
  x = ADR2_time, y = value, fill = Outcomes,
  group = interaction(ADR2_time, Outcomes)
)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +
  scale_y_log10() +
  labs(
    title = "Association between ADRB2 expression in monocytes and outcomes",
    x = "Time of measurement",
    y = "Percentage of monocytes expressing ADRB2\n(log10 scale)"
  ) +
  geom_text(data = count_data_m2, aes(
    x = ADR2_time,
    y = min(F1m_2$value[F1m_2$value > 0], na.rm = TRUE) * 0.5,
    label = paste0("n=", n),
    group = interaction(ADR2_time, Outcomes)
  ),
  position = position_dodge(0.7),
  size = 4,
  vjust = 1) +
  scale_x_discrete(labels = c(
    "ADR2m_J0" = "implantation",
    "ADR2m_J3_J5" = "day 3 to 5",
    "ADR2m_JS" = "explantation"
  )) +
  annotate(
    "text",
    x = 1,
    y = max(F1m_2$value, na.rm = TRUE) * 1.2,
    label = annot_label,
    parse = TRUE,
    size = 4,
    hjust = 0
  )

print(Figure_1m_2)

Fig_1m <- Figure_1m # + theme(plot.title = element_blank())
Fig_1m_2 <- Figure_1m_2 # + theme(plot.title = element_blank())

Figure1m_tot <- Fig_1m + Fig_1m_2 +
  plot_annotation(title = "Association between percentage of monocytes expressing ADRB and Outcome")

print(Figure1m_tot)

```

```{r}
Figure1m_tot
```

Statistical Analysis

To explore the distribution of ADRB1 and ADRB2 expression over time in relation to clinical outcomes, boxplots were generated at three timepoints (implantation, day 3–5, and explantation). To evaluate the association between ADRB1 and ADRB2 expression and clinical outcomes over time, we fitted linear mixed-effects models for repeated measures. For each receptor and cell population (T4 lymphocytes and monocytes), receptor expression levels were analyzed at three predefined timepoints (implantation, day 3–5, and explantation). The primary fixed effects were time, outcome group (ECMO weaning, bridge to LVAD/transplant, or death), and their interaction. Patient-level variability was accounted for by including random intercepts and slopes for time. When appropriate, log10-transformation of expression values was applied to normalize distributions. The significance of interaction effects was assessed by likelihood ratio tests comparing full and reduced models. Type III ANOVA with Kenward-Roger approximation was used to evaluate fixed effects.

Results (T4 lymphocytes)

In patients who were successfully weaned from ECMO, both ADRB1 and ADRB2 expression in T4 lymphocytes showed a progressive increase from implantation to explantation. In contrast, patients who died during ECMO exhibited stable or decreasing receptor expression over time. Although these trends were visually distinguishable, interaction effects between time and outcome group were not statistically significant in the mixed-effects models (ADRB1: p = 0.58; ADRB2: p = 0.76). Nonetheless, a trend toward higher expression over time was observed for both ADRB1 (p[time] = 0.024) and ADRB2 (p[time] = 0.07), with borderline differences among outcome groups for ADRB1 (p[outcomes] = 0.066) and ADRB2 (p[outcomes] = 0.05).

Results (Monocytes)
In contrast to the patterns observed in lymphocytes, no clear time-dependent variation in ADRB1 or ADRB2 expression was detected in monocytes across outcome groups. Boxplots revealed no consistent increase or decrease over time, irrespective of clinical trajectory. This observation was supported by mixed-effects models, which showed no significant effects for time or outcome group on monocyte receptor expression (ADRB1: p[time] = 0.95, p[outcomes] = 0.65; ADRB2: p[time] = 0.94, p[outcomes] = 0.57).


# Figure 2: Association between VTI and ADRB in Lymphocyte at day of weaning

```{r,include=FALSE}

#ADRB1
F2_1_a <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, ADR1_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "<=12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB1
mann_whitney_VTI <- wilcox.test(ADR1_JS ~ VTI_JS, data = F2_1_a)

# Extract and format the p-value
p_value_VTI <- sprintf("%.3f", mann_whitney_VTI$p.value)

count_data <- F2_1_a %>%
  group_by(VTI_JS) %>%
  summarise(n = n())

# Boxplot for ADRB1 with p-value annotation 
Figure2a <- ggplot(F2_1_a, aes(x = VTI_JS, y = log10(ADR1_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  geom_text(data = count_data,
            aes(x = VTI_JS, y = min(log10(F2_1_a$ADR1_JS), na.rm = TRUE) * 1.25,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("<=12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "A",
    x = "VTI measured at 1.5L/min",
    y = "ADRB1 measured ECMO weaning \n (log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text",
           x = 1.5,
           y = max(log10(F2_1_a$ADR1_JS), na.rm = TRUE),
           label = paste("p:", p_value_VTI),
           size = 5, color = "black", hjust = 0.5)

print(Figure2a)

#ADRB2
F2_2_a <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, ADR2_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "<=12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB1
mann_whitney_VTI <- wilcox.test(log10(ADR2_JS) ~ VTI_JS, data = F2_2_a)

# Extract and format the p-value
p_value_VTI <- sprintf("%.3f", mann_whitney_VTI$p.value)

count_data <- F2_2_a %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")

# Boxplot for ADRB2 with p-value annotation 
Figure2b <- ggplot(F2_2_a, aes(x = VTI_JS, y = log10(ADR2_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("<=12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L/min",
    y = "ADRB2 measured at ECMO weaning \n (log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log10(F2_2_a$ADR2_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = min(log10(F2_2_a$ADR2_JS), na.rm = TRUE) * 1.25,  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )

print(Figure2b)

Figure2_tot <- Figure2a | Figure2b +
  plot_annotation(
    title = "Association between VTI at weaning and ADRB1/ADRB2 expression",
    tag_levels = c("A","B")  # Ajoute automatiquement Panel A et B
  )

print(Figure2_tot)

```

```{r}
Figure2_tot
```

# Figure 2_m: Association between VTI and ADRB in Monocytes at day of weaning

```{r,include=FALSE}

# ADRB1

F2_1_m <- df %>%
  select(`jsev_epr_sev_t1_1,5l_itv`, ADR1m_JS) %>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  ) %>%
  na.omit()

# Mann–Whitney test
mw_test_adr1m <- wilcox.test(log10(ADR1m_JS) ~ VTI_JS, data = F2_1_m)

# Extract p-value
p_value_adr1m <- sprintf("%.3f", mw_test_adr1m$p.value)

count_data_m <- F2_1_m %>%
  group_by(VTI_JS) %>%
  summarise(n = n())

# Plot
Figure2m_A <- ggplot(F2_1_m, aes(x = VTI_JS, y = log10(ADR1m_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(data = count_data_m,
            aes(x = VTI_JS,
                y = min(log10(F2_1_m$ADR1m_JS), na.rm = TRUE) * 1.25,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "A",
    x = "VTI measured at 1.5 L/min",
    y = "Monocyte ADRB1 expression at ECMO weaning\n(log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log10(F2_1_m$ADR1m_JS), na.rm = TRUE) * 1.05,
    label = paste("p:", p_value_adr1m),
    size = 5
  )

print(Figure2m_A)

# ADRB2

F2_2_m <- df %>%
  select(`jsev_epr_sev_t1_1,5l_itv`, ADR2m_JS) %>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  ) %>%
  na.omit()

# Mann–Whitney test
mw_test_adr2m <- wilcox.test(log10(ADR2m_JS) ~ VTI_JS, data = F2_2_m)

# Extract p-value
p_value_adr2m <- sprintf("%.3f", mw_test_adr2m$p.value)

count_data_m2 <- F2_2_m %>%
  group_by(VTI_JS) %>%
  summarise(n = n())

# Plot
Figure2m_B <- ggplot(F2_2_m, aes(x = VTI_JS, y = log10(ADR2m_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(data = count_data_m2,
            aes(x = VTI_JS,
                y = min(log10(F2_2_m$ADR2m_JS), na.rm = TRUE) * 1.25,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5 L/min",
    y = "Monocyte ADRB2 expression at ECMO weaning\n(log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log10(F2_2_m$ADR2m_JS), na.rm = TRUE) * 1.05,
    label = paste("p:", p_value_adr2m),
    size = 5
  )

# Combined plot

Figure2m_tot <- Figure2m_A | Figure2m_B +
  plot_annotation(
    title = "Association between VTI at weaning and ADRB1/ADRB2 monocyte expression",
    tag_levels = "A"
  )

print(Figure2m_tot)

```

```{r}
Figure2m_tot
```

Statistical Analysis

To assess the association between ADRB1 and ADRB2 expression at the time of ECMO weaning and left ventricular outflow tract velocity-time integral (VTI) measured at 1.5 L/min ECMO flow, patients were stratified according to a VTI threshold of 12 cm. Mann–Whitney U tests were used to compare log-transformed ADRB expression between the two groups (≤12 cm vs >12 cm). Results were visualized using boxplots.

Results 

In T-lymphocytes, both ADRB1 and ADRB2 expression levels measured at the time of ECMO weaning were significantly lower in patients with a suboptimal VTI (≤12 cm), which is a clinically relevant threshold for considering explantation. The difference reached statistical significance for both markers (ADRB1: p = 0.040; ADRB2: p = 0.041).

In contrast, no statistically significant differences in ADRB1 or ADRB2 expression in monocytes were observed between patients with VTI ≤12 cm and those with VTI >12 cm (all p > 0.1).


## ADR and inotropics

# ADR \~ dobutamin

```{r,include=FALSE}

### Correlation between ADRB1 in Lymphocyte and total dobutamine dose

F3c_a <- df %>%
  select(ADR1_JS, dose_tot_dobu) %>%
  filter(!is.na(ADR1_JS), !is.na(dose_tot_dobu))

# Spearman
correlation_adr1 <- sprintf("%.4f", cor(F3c_a$ADR1_JS, F3c_a$dose_tot_dobu, method = "spearman", use = "complete.obs"))

# Plot 
Fig_3c <- ggplot(F3c_a, aes(x = dose_tot_dobu, y = ADR1_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(title = "Correlation between dobutamine dose and ADRB1",
       x = "Dobutamine dose (µg/kg)",
       y = "ADRB1 expression on T helper lymphocytes") +
  annotate("text", 
           x = min(F3c_a$dose_tot_dobu, na.rm = TRUE), 
           y = max(F3c_a$ADR1_JS, na.rm = TRUE), 
           label = paste("Spearman correlation:", correlation_adr1), 
           hjust = 0, size = 5, color = "black") +
  theme_minimal()


print(Fig_3c)

### Correlation between ADRB2 in Lymphocyte and total dobutamine dose

F3c_b <- df %>%
  dplyr::select(ADR2_JS, dose_tot_dobu) %>%
  filter(!is.na(ADR2_JS), !is.na(dose_tot_dobu))

# Calcolo correlazione Spearman
correlation_adr2 <- sprintf("%.4f", cor(F3c_b$ADR2_JS, F3c_b$dose_tot_dobu, method = "spearman", use = "complete.obs"))

# Plot
Fig_3d <- ggplot(F3c_b, aes(x = dose_tot_dobu, y = ADR2_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(title = "Correlation between dobutamine dose and ADRB2",
       x = "Dobutamine dose (µg/kg)",
       y = "ADRB2 expression on T helper lymphocytes") +
  annotate("text", 
           x = min(F3c_b$dose_tot_dobu, na.rm = TRUE), 
           y = max(F3c_b$ADR2_JS, na.rm = TRUE), 
           label = paste("Spearman correlation:", correlation_adr2), 
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

print(Fig_3d)

### Correlation between ADRB1 in Monocyte and total dobutamine dose

F3c_m1 <- df %>%
  dplyr::select(ADR1m_JS, dose_tot_dobu) %>%
  filter(!is.na(ADR1m_JS), !is.na(dose_tot_dobu))

# Correlazione Spearman
correlation_adr1m <- sprintf("%.4f", cor(F3c_m1$ADR1m_JS, F3c_m1$dose_tot_dobu, method = "spearman"))

# Plot
Fig_3c_m <- ggplot(F3c_m1, aes(x = dose_tot_dobu, y = ADR1m_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(title = "Correlation between dobutamine dose and ADRB1 (monocytes)",
       x = "Dobutamine dose (µg/kg)",
       y = "ADRB1 expression on monocytes at ECMO weaning") +
  annotate("text", 
           x = min(F3c_m1$dose_tot_dobu, na.rm = TRUE), 
           y = max(F3c_m1$ADR1m_JS, na.rm = TRUE), 
           label = paste("Spearman correlation:", correlation_adr1m), 
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

print(Fig_3c_m)

### Correlation between ADRB2 in Monocyte and total dobutamine dose

F3c_m2 <- df %>%
  dplyr::select(ADR2m_JS, dose_tot_dobu) %>%
  filter(!is.na(ADR2m_JS), !is.na(dose_tot_dobu))

# Correlazione Spearman
correlation_adr2m <- sprintf("%.4f", cor(F3c_m2$ADR2m_JS, F3c_m2$dose_tot_dobu, method = "spearman"))

# Plot
Fig_3d_m <- ggplot(F3c_m2, aes(x = dose_tot_dobu, y = ADR2m_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(title = "Correlation between dobutamine dose and ADRB2 (monocytes)",
       x = "Dobutamine dose (µg/kg)",
       y = "ADRB2 expression on monocytes at ECMO weaning") +
  annotate("text", 
           x = min(F3c_m2$dose_tot_dobu, na.rm = TRUE), 
           y = max(F3c_m2$ADR2m_JS, na.rm = TRUE), 
           label = paste("Spearman correlation:", correlation_adr2m), 
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

print(Fig_3d_m)

```

Statistical analysis

The association between cumulative dobutamine dose and the percentage of T-helper lymphocytes/monocyte expressing ADRB was assessed using Spearman's rank correlation coefficient. 

Results

A modest negative correlation was observed for ADRB2 expression (Spearman ρ = –0.25), indicating that higher doses of dobutamine might be associated with lower ADRB2 levels.
In contrast, in monocytes both ADRB1 and ADRB2 expression at ECMO weaning showed a moderate positive correlation with cumulative dobutamine dose (Spearman r = 0.52 for ADRB1 and r = 0.54 for ADRB2), although the association did not reach statistical significance.

#Figure 3: Association of cumulative dobutamine and ADRB in Lymphocyte at day of weaning

```{r}
# ADRB1

F3_a <- df %>%
  select(dose_tot_dobu, ADR1_JS) %>%
  mutate(dobu_cut = case_when(
    dose_tot_dobu > median(dose_tot_dobu, na.rm = TRUE) ~ "> median",
    dose_tot_dobu <= median(dose_tot_dobu, na.rm = TRUE) ~ "≤ median"
  )) %>%
  filter(!is.na(ADR1_JS), !is.na(dose_tot_dobu))%>%
  mutate(dobu_cut = factor(dobu_cut, levels = c("≤ median", "> median")))

# Test di Mann–Whitney
mw_adr1 <- wilcox.test(log10(ADR1_JS) ~ dobu_cut, data = F3_a)
p_val_adr1 <- sprintf("%.3f", mw_adr1$p.value)

count_data_a <- F3_a %>%
  group_by(dobu_cut) %>%
  summarise(n = n(), .groups = "drop")

# Figure ADR1
Figure3a <- ggplot(F3_a, aes(x = dobu_cut, y = log10(ADR1_JS), fill = dobu_cut)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.7, size = 2) +
  geom_text(data = count_data_a,
            aes(x = dobu_cut, y = min(log10(F3_a$ADR1_JS), na.rm = TRUE) * 1.1,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(
    title = "A",
    x = "Cumulative Dobutamine (cut at median)",
    y = "ADRB1 at ECMO weaning (log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text",
           x = 1.5,
           y = max(log10(F3_a$ADR1_JS), na.rm = TRUE) * 1.15,
           label = paste("p:", p_val_adr1),
           size = 5)

# ADRB2

F3_b <- df %>%
  select(dose_tot_dobu, ADR2_JS) %>%
  mutate(dobu_cut = case_when(
    dose_tot_dobu > median(dose_tot_dobu, na.rm = TRUE) ~ "> median",
    dose_tot_dobu <= median(dose_tot_dobu, na.rm = TRUE) ~ "≤ median"
  )) %>%
  filter(!is.na(ADR2_JS), !is.na(dose_tot_dobu))%>%
  mutate(dobu_cut = factor(dobu_cut, levels = c("≤ median", "> median")))

# Test
mw_adr2 <- wilcox.test(log10(ADR2_JS) ~ dobu_cut, data = F3_b)
p_val_adr2 <- sprintf("%.3f", mw_adr2$p.value)

count_data_b <- F3_b %>%
  group_by(dobu_cut) %>%
  summarise(n = n(), .groups = "drop")

# Figure ADR2
Figure3b <- ggplot(F3_b, aes(x = dobu_cut, y = log10(ADR2_JS), fill = dobu_cut)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.7, size = 2) +
  geom_text(data = count_data_b,
            aes(x = dobu_cut, y = min(log10(F3_b$ADR2_JS), na.rm = TRUE) * 1.1,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(
    title = "B",
    x = "Cumulative Dobutamine (cut at median)",
    y = "ADRB2 at ECMO weaning (log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text",
           x = 1.5,
           y = max(log10(F3_b$ADR2_JS), na.rm = TRUE) * 1.15,
           label = paste("p:", p_val_adr2),
           size = 5)

# === Combine ===
Figure3_dobu_cum <- Figure3a + Figure3b +
  plot_annotation(title = "Association between cumulative dose of Dobutamine and ADRB1/ADRB2 expression at ECMO weaning")

print(Figure3_dobu_cum)

```

```{r}
Figure3_dobu_cum
```

#Figure 3_m: Association of cumulative dobutamine and ADRB in Monocyte at day of weaning

```{r,include=FALSE}

## ADRB1

# Prepare data
F3_m_a <- df %>%
  select(dose_tot_dobu, ADR1m_JS) %>%
  mutate(
    dobu_cut = case_when(
      dose_tot_dobu > median(dose_tot_dobu, na.rm = TRUE) ~ "> median",
      TRUE ~ "≤ median"
    )
  ) %>%
  filter(!is.na(ADR1m_JS), !is.na(dose_tot_dobu)) %>%
  mutate(dobu_cut = factor(dobu_cut, levels = c("≤ median", "> median")))


# Mann–Whitney test
mw_test_adr1m <- wilcox.test(log10(ADR1m_JS) ~ dobu_cut, data = F3_m_a)
p_value_adr1m <- sprintf("%.3f", mw_test_adr1m$p.value)

# Count per group
count_data_adr1m <- F3_m_a %>%
  group_by(dobu_cut) %>%
  summarise(n = n())

# Plot
Figure3_dobu_cum_a <- ggplot(F3_m_a, aes(x = dobu_cut, y = log10(ADR1m_JS), fill = dobu_cut)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.7, size = 2) +
  geom_text(data = count_data_adr1m, aes(x = dobu_cut, y = min(log10(F3_m_a$ADR1m_JS), na.rm = TRUE) * 1.25,
                                         label = paste0("n=", n)), inherit.aes = FALSE, size = 4) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(title = "A", x = "Cumulative Dobutamine", y = "ADRB1 in monocytes at weaning (log10)") +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text", x = 1.5, y = max(log10(F3_m_a$ADR1m_JS), na.rm = TRUE), label = paste("p:", p_value_adr1m), size = 5)

##ADRB2

# Prepare data
F3_m_b <- df %>%
  select(dose_tot_dobu, ADR2m_JS) %>%
  mutate(
    dobu_cut = case_when(
      dose_tot_dobu > median(dose_tot_dobu, na.rm = TRUE) ~ "> median",
      TRUE ~ "≤ median"
    )
  ) %>%
  filter(!is.na(ADR2m_JS), !is.na(dose_tot_dobu))%>%
  mutate(dobu_cut = factor(dobu_cut, levels = c("≤ median", "> median")))

# Mann–Whitney test
mw_test_adr2m <- wilcox.test(log10(ADR2m_JS) ~ dobu_cut, data = F3_m_b)
p_value_adr2m <- sprintf("%.3f", mw_test_adr2m$p.value)

# Count per group
count_data_adr2m <- F3_m_b %>%
  group_by(dobu_cut) %>%
  summarise(n = n())

# Plot
Figure3_dobu_cum_b <- ggplot(F3_m_b, aes(x = dobu_cut, y = log10(ADR2m_JS), fill = dobu_cut)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.7, size = 2) +
  geom_text(data = count_data_adr2m, aes(x = dobu_cut, y = min(log10(F3_m_b$ADR2m_JS), na.rm = TRUE) * 1.25,
                                         label = paste0("n=", n)), inherit.aes = FALSE, size = 4) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(title = "B", x = "Cumulative Dobutamine", y = "ADRB2 in monocytes at weaning (log10)") +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text", x = 1.5, y = max(log10(F3_m_b$ADR2m_JS), na.rm = TRUE), label = paste("p:", p_value_adr2m), size = 5)

# Cumulative
Figure3m_dobu_cum <- Figure3_dobu_cum_a + Figure3_dobu_cum_b +
  plot_annotation(title = "Association between cumulative dobutamine and ADR expression in monocytes")

print(Figure3m_dobu_cum)

```

```{r}
Figure3m_dobu_cum
```

Statistical Analysis

As evolution of some patients allowed an early weaning before D5, we considered that D3-D5 and D weaning are the same time point. To explore whether cumulative exposure to inotropic stimulation was associated with β-adrenergic receptor modulation over time, we investigated the relationship between the total cumulative dose of dobutamine (expressed in µg/kg) and ADRB1/ADRB2 expression at ECMO weaning (JS).
This timepoint was selected as it reflects the net effect of continuous pharmacological stimulation throughout the ECMO course, thereby allowing the assessment of potential receptor adaptation (e.g., up- or downregulation).

First, we performed a correlation analysis between cumulative dobutamine dose and ADRB1/ADRB2 expression using Spearman’s rank correlation coefficient, due to the non-normal distribution of the data.
Second, patients were stratified according to the median of cumulative dobutamine dose. Expression levels of ADRB1 and ADRB2 (in both CD4+ lymphocytes and monocytes) at ECMO weaning were compared between patients above versus below the median using the Mann–Whitney U test. A two-sided p-value < 0.05 was considered statistically significant.

Results

Among lymphocytes, there was no significant difference in ADRB expression between patients with higher versus lower cumulative dobutamine exposure. ADRB1 levels were comparable across groups, while a trend toward lower ADRB2 expression was observed in patients who received higher doses of dobutamine.

In contrast, monocyte expression patterns followed a more consistent trend. Both ADRB1 and ADRB2 expression levels tended to be lower in patients exposed to higher cumulative doses of dobutamine, although this association did not reach statistical significance.

# ADR \~ noradrenalin

```{r,include=FALSE}

### Correlation between ADRB1 in Lymphocyte and total noradrenalin dose

df4 <- df %>%
  dplyr::select(dose_tot_NAd, ADR1_JS, Weight) %>%
  filter(!is.na(ADR1_JS), !is.na(dose_tot_NAd)) %>%
  mutate(NAD_per_kg = dose_tot_NAd / Weight)

# Correlation
correlation_adr1 <- sprintf("%.4f", cor(df4$ADR1_JS, df4$dose_tot_NAd, method = "spearman", use = "complete.obs"))

# Plot ADRB1
Figure_4_NADcum_A <- ggplot(df4, aes(x = dose_tot_NAd, y = ADR1_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(
    title = "Correlation between noradrenaline dose and ADRB1 (lymphocytes)",
    x = "Cumulative noradrenaline dose (mg)",
    y = "ADRB1 expression at ECMO weaning (JS)"
  ) +
  annotate(
    "text",
    x = min(df4$dose_tot_NAd, na.rm = TRUE),
    y = max(df4$ADR1_JS, na.rm = TRUE) * 0.95,
    label = paste("Spearman correlation:", correlation_adr1),
    hjust = 0,
    size = 5,
    color = "black"
  ) +
  theme_minimal()


print(Figure_4_NADcum_A)


### Correlation between ADRB2 in Lymphocyte and total noradrenalin dose

df4 <- df %>%
  dplyr::select(dose_tot_NAd, ADR2_JS, Weight) %>%
  filter(!is.na(ADR2_JS), !is.na(dose_tot_NAd)) %>%
  mutate(NAD_per_kg = dose_tot_NAd / Weight)

correlation_adr2 <- sprintf("%.4f", cor(df4$ADR2_JS, df4$dose_tot_NAd, method = "spearman", use = "complete.obs"))

Figure_4_NADcum_B <- ggplot(df4, aes(x = dose_tot_NAd, y = ADR2_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(
    title = "Correlation between noradrenaline dose and ADRB2 (lymphocytes)",
    x = "Cumulative noradrenaline dose (mg)",
    y = "ADRB2 expression at ECMO weaning (JS)"
  ) +
  annotate(
    "text",
    x = min(df4$dose_tot_NAd, na.rm = TRUE),
    y = max(df4$ADR2_JS, na.rm = TRUE) * 0.95,
    label = paste("Spearman correlation:", correlation_adr2),
    hjust = 0,
    size = 5,
    color = "black"
  ) +
  theme_minimal()

print(Figure_4_NADcum_B)

### Correlation between ADRB1 in Monocyte and total noradrenalin dose

df4 <- df %>%
  select(ADR1m_JS, dose_tot_NAd, Weight) %>%
  filter(!is.na(ADR1m_JS), !is.na(dose_tot_NAd)) %>%
  mutate(NAD_per_kg = dose_tot_NAd / Weight)

# Spearman correlation
cor_adr1m <- sprintf("%.4f", cor(df4$ADR1m_JS, df4$dose_tot_NAd, method = "spearman", use = "complete.obs"))

# Plot
Figure4_NADmono_A <- ggplot(df4, aes(x = dose_tot_NAd, y = ADR1m_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(
    title = "Correlation between Noradrenaline dose and ADRB1 (monocytes)",
    x = "Cumulative noradrenaline dose (mg)",
    y = "Monocyte ADRB1 expression at ECMO weaning"
  ) +
  annotate("text",
           x = min(df4$dose_tot_NAd, na.rm = TRUE),
           y = max(df4$ADR1m_JS, na.rm = TRUE) * 0.95,
           label = paste("Spearman correlation:", cor_adr1m),
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

print(Figure4_NADmono_A)

### Correlation between ADRB2 in Monocyte and total noradrenalin dose

df4 <- df %>%
  select(ADR2m_JS, dose_tot_NAd, Weight) %>%
  filter(!is.na(ADR2m_JS), !is.na(dose_tot_NAd)) %>%
  mutate(NAD_per_kg = dose_tot_NAd / Weight)

# Spearman correlation
cor_adr2m <- sprintf("%.4f", cor(df4$ADR2m_JS, df4$dose_tot_NAd, method = "spearman", use = "complete.obs"))

# Plot
Figure4_NADmono_B <- ggplot(df4, aes(x = dose_tot_NAd, y = ADR2m_JS)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(
    title = "Correlation between Noradrenaline dose and ADRB2 (monocytes)",
    x = "Cumulative noradrenaline dose (mg)",
    y = "Monocyte ADRB2 expression at ECMO weaning"
  ) +
  annotate("text",
           x = min(df4$dose_tot_NAd, na.rm = TRUE),
           y = max(df4$ADR2m_JS, na.rm = TRUE) * 0.95,
           label = paste("Spearman correlation:", cor_adr2m),
           hjust = 0, size = 5, color = "black") +
  theme_minimal()

print(Figure4_NADmono_B)

```

Results

No significant correlations were observed between cumulative noradrenaline dose and ADRB1 or ADRB2 expression in either T helper lymphocytes (r = –0.09 and –0.29, respectively) or monocytes (r = –0.18 and 0.02, respectively).

## Figure 4: Association of cumulative noradrenaline and ADRB in Lymphocyte at day of weaning

```{r,include=FALSE}

### ADRB1 in T lymphocytes ~ cumulative NAd (median)

F5a <- df %>%
  mutate(
    ADR1_JS_clean = case_when(
      !is.na(ADR1_JS) ~ ADR1_JS,
      is.na(ADR1_JS) & !is.na(ADR1_J3_J5) ~ ADR1_J3_J5,
      TRUE ~ NA_real_
    ),
    NAd_group = case_when(
      dose_tot_NAd > median(dose_tot_NAd, na.rm = TRUE) ~ "> median",
      dose_tot_NAd <= median(dose_tot_NAd, na.rm = TRUE) ~ "≤ median",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(ADR1_JS_clean), !is.na(NAd_group)) %>%
  mutate(NAd_group = factor(NAd_group, levels = c("≤ median", "> median")))

# p-value (Mann–Whitney)
wilcox_test_adr1 <- wilcox.test(ADR1_JS_clean ~ NAd_group, data = F5a)
p_value_adr1 <- sprintf("%.3f", wilcox_test_adr1$p.value)

count_data_adr1 <- F5a %>%
  group_by(NAd_group) %>%
  summarise(n = n())

# Boxplot
Figure_5a <- ggplot(F5a, aes(x = NAd_group, y = ADR1_JS_clean, fill = NAd_group)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(
    data = count_data_adr1,
    aes(x = NAd_group, y = min(F5a$ADR1_JS_clean, na.rm = TRUE) * 1.2,
        label = paste0("n=", n)),
    size = 4,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(
    title = "A",
    x = "Cumulative noradrenaline dose",
    y = "ADRB1 expression at ECMO weaning"
  ) +
  annotate("text",
           x = 1.5,
           y = max(F5a$ADR1_JS_clean, na.rm = TRUE) * 1.05,
           label = paste("p:", p_value_adr1),
           size = 5, color = "black") +
  theme_minimal() +
  theme(legend.position = "none")

print(Figure_5a)

### ADRB2 in T lymphocytes ~ cumulative NAd (median)

F5b <- df %>%
  mutate(
    ADR2_JS_clean = case_when(
      !is.na(ADR2_JS) ~ ADR2_JS,
      is.na(ADR2_JS) & !is.na(ADR2_J3_J5) ~ ADR2_J3_J5,
      TRUE ~ NA_real_
    ),
    NAd_group = case_when(
      dose_tot_NAd > median(dose_tot_NAd, na.rm = TRUE) ~ "> median",
      dose_tot_NAd <= median(dose_tot_NAd, na.rm = TRUE) ~ "≤ median",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(ADR2_JS_clean), !is.na(NAd_group)) %>%
  mutate(NAd_group = factor(NAd_group, levels = c("≤ median", "> median")))

# Test di Mann–Whitney
wilcox_test_adr2 <- wilcox.test(ADR2_JS_clean ~ NAd_group, data = F5b)
p_value_adr2 <- sprintf("%.3f", wilcox_test_adr2$p.value)

# Conta per gruppo
count_data_adr2 <- F5b %>%
  group_by(NAd_group) %>%
  summarise(n = n())

# Boxplot
Figure_5b <- ggplot(F5b, aes(x = NAd_group, y = ADR2_JS_clean, fill = NAd_group)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(
    data = count_data_adr2,
    aes(x = NAd_group, y = min(F5b$ADR2_JS_clean, na.rm = TRUE) * 1.2,
        label = paste0("n=", n)),
    size = 4,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(
    title = "B",
    x = "Cumulative noradrenaline dose",
    y = "ADRB2 expression at ECMO weaning"
  ) +
  annotate("text",
           x = 1.5,
           y = max(F5b$ADR2_JS_clean, na.rm = TRUE) * 1.05,
           label = paste("p:", p_value_adr2),
           size = 5, color = "black") +
  theme_minimal() +
  theme(legend.position = "none")

print(Figure_5b)

Figure_5a <- Figure_5a + theme(plot.title = element_blank())
Figure_5b <- Figure_5b + theme(plot.title = element_blank())

# Combinazione dei due plot
Figure4_tot <- Figure_5a + Figure_5b +
  plot_annotation(
    title = "Association between cumulative noradrenaline dose and β-adrenergic receptor expression on T helper lymphocytes"
  )

print(Figure4_tot)

```

```{r}
Figure4_tot
```

Figure 4m: Association of cumulative noradrenaline and ADRB in MOnocyte at day of weaning

```{r,include=FALSE}

cut_median_nad <- median(df$dose_tot_NAd, na.rm = TRUE)

#ADRB1m
F4_m_a <- df %>%
  select(dose_tot_NAd, ADR1m_JS, ADR1m_J3_J5) %>%
  mutate(
    ADR1m_final = case_when(
      !is.na(ADR1m_JS) ~ ADR1m_JS,
      is.na(ADR1m_JS) & !is.na(ADR1m_J3_J5) ~ ADR1m_J3_J5,
      TRUE ~ NA_real_
    ),
    NAd_cut = case_when(
      dose_tot_NAd <= cut_median_nad ~ "≤ median",
      dose_tot_NAd > cut_median_nad ~ "> median",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(ADR1m_final), !is.na(NAd_cut))

# P-value
p_val_adr1m <- wilcox.test(ADR1m_final ~ NAd_cut, data = F4_m_a)$p.value
p_text_adr1m <- paste("p:", format(round(p_val_adr1m, 3), nsmall = 3))

# Count
count_data_m1 <- F4_m_a %>%
  group_by(NAd_cut) %>%
  summarise(n = n())

# Plot ADRB1m
Figure4m_A <- ggplot(F4_m_a, aes(x = NAd_cut, y = log10(ADR1m_final), fill = NAd_cut)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(data = count_data_m1,
            aes(x = NAd_cut, y = min(log10(F4_m_a$ADR1m_final), na.rm = TRUE) * 1.2,
                label = paste0("n=", n)),
            size = 4, inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(
    title = "A",
    x = "Cumulative norepinephrine dose",
    y = "Monocyte ADRB1 expression at ECMO weaning\n(log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text", x = 1.5,
           y = max(log10(F4_m_a$ADR1m_final), na.rm = TRUE) * 1.15,
           label = p_text_adr1m,
           size = 5)


# ADRB2m

F4_m_b <- df %>%
  select(dose_tot_NAd, ADR2m_JS, ADR2m_J3_J5) %>%
  mutate(
    ADR2m_final = case_when(
      !is.na(ADR2m_JS) ~ ADR2m_JS,
      is.na(ADR2m_JS) & !is.na(ADR2m_J3_J5) ~ ADR2m_J3_J5,
      TRUE ~ NA_real_
    ),
    NAd_cut = case_when(
      dose_tot_NAd <= cut_median_nad ~ "≤ median",
      dose_tot_NAd > cut_median_nad ~ "> median",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(ADR2m_final), !is.na(NAd_cut))

# P-value
p_val_adr2m <- wilcox.test(ADR2m_final ~ NAd_cut, data = F4_m_b)$p.value
p_text_adr2m <- paste("p:", format(round(p_val_adr2m, 3), nsmall = 3))

# Count
count_data_m2 <- F4_m_b %>%
  group_by(NAd_cut) %>%
  summarise(n = n())

# Plot ADRB2m
Figure4m_B <- ggplot(F4_m_b, aes(x = NAd_cut, y = log10(ADR2m_final), fill = NAd_cut)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(data = count_data_m2,
            aes(x = NAd_cut, y = min(log10(F4_m_b$ADR2m_final), na.rm = TRUE) * 1.2,
                label = paste0("n=", n)),
            size = 4, inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤ median" = "#0072B2", "> median" = "#D55E00")) +
  labs(
    title = "B",
    x = "Cumulative norepinephrine dose",
    y = "Monocyte ADRB2 expression at ECMO weaning\n(log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text", x = 1.5,
           y = max(log10(F4_m_b$ADR2m_final), na.rm = TRUE) * 1.15,
           label = p_text_adr2m,
           size = 5)

# Combine plots

Figure4_mono <- Figure4m_A + Figure4m_B +
  plot_annotation(title = "Association between cumulative norepinephrine dose and ADRB1/2 expression in monocytes at ECMO weaning")

print(Figure4_mono)

```

```{r}
Figure4_mono
```

Among lymphocytes, both ADRB1 and ADRB2 expression at ECMO weaning tended to be lower in patients receiving a cumulative noradrenaline dose above the median. However, these differences did not reach statistical significance.

Among monocytes, ADRB1 expression at ECMO weaning was significantly lower in patients receiving a cumulative norepinephrine dose above the median compared to those below (p = 0.039). A similar trend was observed for ADRB2 expression, although the difference did not reach statistical significance (p = 0.077).

While Spearman correlation analyses did not reveal a significant association between cumulative norepinephrine dose and ADRB1/ADRB2 expression in monocytes, patients with doses above the median exhibited significantly lower ADRB1 levels at ECMO weaning (p = 0.039). This suggests that potential receptor downregulation may occur only above a certain threshold of catecholaminergic stimulation.

## ADR \~ levosimendan

# Figure 5: Association of Levosimendan and ADRB in Lymphocyte at day 3-5

```{r,include=FALSE}

#ADRB1

F5_lym <- df %>%
  dplyr::select(Levosimendan, ADR1_J3_J5) %>%
  filter(!is.na(Levosimendan), !is.na(ADR1_J3_J5)) %>%
  mutate(log_ADR1 = log10(ADR1_J3_J5))

# p-value
p_adr1 <- sprintf("%.4f", wilcox.test(log_ADR1 ~ Levosimendan, data = F5_lym, exact = FALSE)$p.value)

# count 
count_data_adr1 <- F5_lym %>%
  group_by(Levosimendan) %>%
  summarise(n = n(), .groups = "drop")

# Boxplot
Figure_5A <- ggplot(F5_lym, aes(x = Levosimendan, y = log_ADR1, fill = Levosimendan)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(data = count_data_adr1,
            aes(x = Levosimendan,
                y = min(F5_lym$log_ADR1, na.rm = TRUE) * 1.25,
                label = paste0("n=", n)),
            inherit.aes = FALSE,
            size = 4) +
  scale_fill_manual(values = c("NO" = "#0072B2", "YES" = "#D55E00")) +
  labs(title = "ADRB1 expression on T helper lymphocytes",
       x = "Levosimendan",
       y = "ADRB1 at D3–D5 of ECMO (log10 scale)") +
  annotate("text", x = 1.5, y = max(F5_lym$log_ADR1, na.rm = TRUE),
           label = paste("Mann–Whitney p =", p_adr1),
           size = 5, hjust = 0.5, color = "black") +
  theme_minimal() +
  theme(legend.position = "none")

print(Figure_5A)

#ADRB2

F5_lym_b <- df %>%
  dplyr::select(Levosimendan, ADR2_J3_J5) %>%
  filter(!is.na(Levosimendan), !is.na(ADR2_J3_J5)) %>%
  mutate(log_ADR2 = log10(ADR2_J3_J5))

# p-value
p_adr2 <- sprintf("%.4f", wilcox.test(log_ADR2 ~ Levosimendan, data = F5_lym_b, exact = FALSE)$p.value)

# count 
count_data_adr2 <- F5_lym_b %>%
  group_by(Levosimendan) %>%
  summarise(n = n(), .groups = "drop")

# Boxplot
Figure_5B <- ggplot(F5_lym_b, aes(x = Levosimendan, y = log_ADR2, fill = Levosimendan)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), size = 2, alpha = 0.7) +
  geom_text(data = count_data_adr2,
            aes(x = Levosimendan,
                y = min(F5_lym_b$log_ADR2, na.rm = TRUE) * 1.25,
                label = paste0("n=", n)),
            inherit.aes = FALSE,
            size = 4) +
  scale_fill_manual(values = c("NO" = "#0072B2", "YES" = "#D55E00")) +
  labs(title = "ADRB2 expression on T helper lymphocytes",
       x = "Levosimendan",
       y = "ADRB2 at D3–D5 of ECMO (log10 scale)") +
  annotate("text", x = 1.5, y = max(F5_lym_b$log_ADR2, na.rm = TRUE),
           label = paste("Mann–Whitney p =", p_adr2),
           size = 5, hjust = 0.5, color = "black") +
  theme_minimal() +
  theme(legend.position = "none")

Figure_5A <- Figure_5A + theme(plot.title = element_blank())
Figure_5B <- Figure_5B + theme(plot.title = element_blank())

Figure5_tot_log <- Figure_5A + Figure_5B +
  plot_annotation(title = "Association between Levosimendan and ADRB expression (log scale) at D3–D5")

print(Figure5_tot_log)
```

```{r}
Figure5_tot_log
```

Figure 5m: Association of Levosimendan and ADRB in Monocyte at day of weaning

```{r,include=FALSE}

# ADRB1 
F5_mon_a <- df %>%
  dplyr::select(Levosimendan, ADR1m_J3_J5) %>%
  filter(!is.na(Levosimendan), !is.na(ADR1m_J3_J5))

# P-value
p_adr1m <- sprintf("%.4f", wilcox.test(ADR1m_J3_J5 ~ Levosimendan, data = F5_mon_a, exact = FALSE)$p.value)

# Count per group
count_data_adr1m <- F5_mon_a %>%
  group_by(Levosimendan) %>%
  summarise(n = n())

# Boxplot
Figure_5Am <- ggplot(F5_mon_a, aes(x = Levosimendan, y = log10(ADR1m_J3_J5), fill = Levosimendan)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  geom_text(data = count_data_adr1m,
            aes(x = Levosimendan, y = min(log10(F5_mon_a$ADR1m_J3_J5), na.rm = TRUE) * 1.2,
                label = paste0("n=", n)),
            inherit.aes = FALSE,
            size = 4) +
  scale_fill_manual(values = c("NO" = "#0072B2", "YES" = "#D55E00")) +
  labs(title = "A",
       x = "Levosimendan",
       y = "Monocyte ADRB1 expression at D3–D5 (log10 scale)") +
  annotate("text", x = 1.5, y = max(log10(F5_mon_a$ADR1m_J3_J5), na.rm = TRUE),
           label = paste("Mann–Whitney p =", p_adr1m),
           size = 5, color = "black", hjust = 0.5) +
  theme_minimal() +
  theme(legend.position = "none")


# ADRB2 
F5_mon_b <- df %>%
  dplyr::select(Levosimendan, ADR2m_J3_J5) %>%
  filter(!is.na(Levosimendan), !is.na(ADR2m_J3_J5))

# P-value
p_adr2m <- sprintf("%.4f", wilcox.test(ADR2m_J3_J5 ~ Levosimendan, data = F5_mon_b, exact = FALSE)$p.value)

count_data_adr2m <- F5_mon_b %>%
  group_by(Levosimendan) %>%
  summarise(n = n())

# Boxplot
Figure_5Bm <- ggplot(F5_mon_b, aes(x = Levosimendan, y = log10(ADR2m_J3_J5), fill = Levosimendan)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  geom_text(data = count_data_adr2m,
            aes(x = Levosimendan, y = min(log10(F5_mon_b$ADR2m_J3_J5), na.rm = TRUE) * 1.2,
                label = paste0("n=", n)),
            inherit.aes = FALSE,
            size = 4) +
  scale_fill_manual(values = c("NO" = "#0072B2", "YES" = "#D55E00")) +
  labs(title = "B",
       x = "Levosimendan",
       y = "Monocyte ADRB2 expression at D3–D5 (log10 scale)") +
  annotate("text", x = 1.5, y = max(log10(F5_mon_b$ADR2m_J3_J5), na.rm = TRUE),
           label = paste("Mann–Whitney p =", p_adr2m),
           size = 5, color = "black", hjust = 0.5) +
  theme_minimal() +
  theme(legend.position = "none")

#Combined

Figure_5Am <- Figure_5Am + theme(plot.title = element_blank())
Figure_5Bm <- Figure_5Bm + theme(plot.title = element_blank())

Figure5_mon_tot <- Figure_5Am + Figure_5Bm +
  plot_annotation(title = "Association between Levosimendan and ADRB expression on monocytes at D3–D5 of ECMO",
                  tag_levels = "A")

print(Figure5_mon_tot)

```

```{r}
Figure5_mon_tot
```

Results 

ADRB2 expression at D3-D5 is significantly different between patients who received Levosimendan and those who did not. NO difference where seen in monocytes.

# Figure 6: Survival \~ ADR in Lymphocyte

```{r,include=FALSE}

# ADRB1
km_fit <- survfit(Surv(diff_days_J28, Outcome_censored_28) ~ ADR1_D0_median, data = df)

Fig_9 <- ggsurvplot(km_fit, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 28),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Fig_9 <- Fig_9 + ggtitle("28-day Survival Curves for ADRB1")
print(Fig_9)

# ADRB2
km_fit <- survfit(Surv(diff_days_J28, Outcome_censored_28) ~ ADR2_D0_median, data = df)

Fig_9.1 <- ggsurvplot(km_fit, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 28),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),  
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Fig_9.1 <- Fig_9.1 + ggtitle("28-day Survival Curves for ADRB2")
print(Fig_9.1)

# Combine the plots (ADR1 and ADR2) side by side with the risk tables
Fig_9_combined <- plot_grid(Fig_9$plot, Fig_9$table, ncol = 1, align = "v", rel_heights = c(3, 1))
Fig_9.1_combined <- plot_grid(Fig_9.1$plot, Fig_9.1$table, ncol = 1, align = "v", rel_heights = c(3, 1))

# Remove titles from individual plots
Fig_9_combined <- Fig_9_combined + theme(plot.title = element_blank())
Fig_9.1_combined <- Fig_9.1_combined + theme(plot.title = element_blank())

# Combine both survival plots (ADR1 and ADR2) together with a title
Fig9_tot <- plot_grid(Fig_9_combined, Fig_9.1_combined, ncol = 2, align = "h")

# Add a title to the combined figure
Fig9_tot <- Fig9_tot + plot_annotation(title = "28-day Survival Curves for ADRB")

# Print the final combined plot
print(Fig9_tot)

```

```{r}
Fig9_tot
```

# Figure 6m: Survival \~ ADR in Monocyte

```{r,include=FALSE}

df_surv_m1 <- df %>%
  filter(!is.na(ADR1m_D0_median), !is.na(diff_days_J28), !is.na(Outcome_censored_28))

# ADRB1 on Monocytes
km_fit_m1 <- survfit(Surv(diff_days_J28, Outcome_censored_28) ~ ADR1m_D0_median, data = df_surv_m1)


Fig_m1 <- ggsurvplot(km_fit_m1, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 28),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Fig_m1 <- Fig_m1 + ggtitle("28-day Survival Curves for ADRB1 (Monocytes)")
print(Fig_m1)

# ADRB2 on Monocytes
km_fit_m2 <- survfit(Surv(diff_days_J28, Outcome_censored_28) ~ ADR2m_D0_median, data = df)

Fig_m2 <- ggsurvplot(km_fit_m2, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 28),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),  
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Fig_m2 <- Fig_m2 + ggtitle("28-day Survival Curves for ADRB2 (Monocytes)")
print(Fig_m2)

# Combine plots
Fig_m1_combined <- plot_grid(Fig_m1$plot, Fig_m1$table, ncol = 1, align = "v", rel_heights = c(3, 1))
Fig_m2_combined <- plot_grid(Fig_m2$plot, Fig_m2$table, ncol = 1, align = "v", rel_heights = c(3, 1))

Fig_m1_combined <- Fig_m1_combined + theme(plot.title = element_blank())
Fig_m2_combined <- Fig_m2_combined + theme(plot.title = element_blank())

Fig_monocyte_survival <- Fig_m1_combined + Fig_m2_combined +
  plot_annotation(title = "28-day Survival Curves for ADRB (Monocytes)")

print(Fig_monocyte_survival)

```

```{r}
Fig_monocyte_survival
```

Statistical analysis

To assess the prognostic significance of baseline β-adrenergic receptor expression, we stratified patients based on the median value of ADRB1 and ADRB2 measured at ECMO initiation (D0). Survival analysis was performed using Kaplan–Meier curves and the log-rank test to compare 28-day survival between patients with “High” vs “Low” expression. Patients were censored at the time of ECMO weaning, heart transplantation or LVAD implantation. 

Results

Although the differences did not reach statistical significance, a trend was observed indicating that patients with higher ADRB expression in both lymphocytes and monocytes at ECMO initiation had lower 28-day survival probability. This pattern suggests a potential association between adrenergic receptor activation and worse short-term outcomes.
