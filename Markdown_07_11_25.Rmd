---
title: "ADRECMO"
author: "Jolie Bruno, Antoine Kimmoun, Kevin Duarte, Feriel Azibani, Benjamin Deniaun"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    theme: journal
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
    latex_engine: pdflatex
  word_document: null
editor_options:
  chunk_output_type: console
always_allow_html: yes
---

```{=html}
<style type="text/css">

h1.title {
  font-size: 38px;
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
    font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  text-align: center;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  text-align: center;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# markdown options depending on the output (html with R code and Word without)
output <- knitr::opts_knit$get("rmarkdown.pandoc.to")
if (output=="html") knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = TRUE, comment = "", fig.align = "center", fig.width= 17, fig.asp =0.70, out.width = "90%")
if (output=="docx") knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE, comment = "", fig.align = "center", fig.width= 17, fig.asp =0.70, out.width = "90%")
if (output=="pdf") knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo = FALSE, comment = "", fig.align = "center", fig.width= 17, fig.asp =0.70, out.width = "90%")
options(max.print = .Machine$integer.max)
```

#Package
```{r,include=FALSE}
library(tidyverse)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(gtsummary)
library(sjlabelled)
library(readxl)
library(purrr)
library(tableone)
library(naniar)
library(survival)
library(survminer)
library(patchwork)
library(ggpmisc)
library(cowplot)  
library(officer)
library(flextable)
library(lme4)
library(lmerTest)
library(emmeans)
library(forcats)
```

# Method

This study is a monocentric, prospective, observational investigation conducted in Nancy Hospital between 10.10.2017 and 24.05.2022, enrolling 50 adult patients with refractory cardiogenic shock requiring veno-arterial extracorporeal membrane oxygenation (VA-ECMO) support (NCT03327493).

The study was carried out in accordance with the Declaration of Helsinki and approved by the local institutional ethics committee. Written informed consent was obtained from all patients or their legal representatives prior to inclusion.

## Patient Population

Cardiogenic shock was defined as a systolic blood pressure (SBP) <90 mmHg or a mean arterial pressure (MAP) <65 mmHg despite adequate volume resuscitation, accompanied by signs of peripheral hypoperfusion (e.g., cold extremities, oliguria, altered mental status) and a cardiac index <2.2 L/min/m². Refractoriness was defined as a hyporesponsiveness to norepinephrine and/or the persistence of profound clinical signs of hypoperfusion despite optimal resuscitation efforts.
Eligible patients were adults (≥18 years old) affiliated with a  health insurance system. Cardiogenic shock etiologies included acute ischemic coronary artery disease, primary or ischemic-related dilated cardiomyopathy, myocarditis and stress-induced cardiomyopathy. Patients were excluded if cardiogenic shock was secondary to cardiotoxic poisoning, if they were pregnant, or were under legal protective supervision (e.g., court-appointed guardianship).

## Data Collection

Clinical, laboratory and echocardiographic parameters were prospectively collected at three predefined timepoints:Day 0 (ECMO implantation), Day 3–5 (early course) and Day of ECMO weaning (ECMO explantation). Blood samples were drawn at each timepoint, immediately centrifuged and plasma was stored at –80°C until analysis. Samples were then transferred to the XXX for cells analysis and INSERM UMR942 laboratory (Paris, France) for cytokine analysis. Quantification of adrenoreceptors β1 and β2 on monocytes and CD4⁺ T lymphocytes was performed using flow cytometry. Cytokine concentrations in plasma, including interleukin (IL) -33, IL-1β, IL-2, IL-4, IL-5, IL-6, IL-8/CXCL8, IL-10, GDF-15, IL-12p70, IL-17A/CTLA-8, IFN-γ, TNF-α and granzyme B, were measured using [XXX].

## Assessment of ADRB1 and ADRB2

The expression of β1 (ADRB1) and β2 (ADRB2) adrenergic receptors on circulating immune cell, namely CD4+ T lymphocytes and monocytes, was assessed via flow cytometry. XXX [to be completed from Manon]. Results were expressed as the percentage of cells that were positive for the respective expression receptors.

##Cytokine Quantification

The aforementioned panel of circulating cytokines and immune mediators was quantified from plasma samples. These biomarkers were selected for their roles in pro- and anti-inflammatory signaling. Measurements were performed using a multiplex bead-based immunoassay (Luminex platform), following the manufacturer’s instructions. XXX [to be completed from Malha].

##ECMO Weaning Protocol

A standardized weaning protocol was applied to all patients prior to ECMO explantation. At a constant mean arterial pressure (MAP) between 65 and 75 mmHg, cardiac output was assessed by transthoracic echocardiography at two predefined timepoints: 1. Baseline under full support (ECLS flow at 3.0 L/min) and 2. Low-flow test after 45 minutes of reduced ECMO flow (1.5 L/min).
Measurements included velocity time integral (VTI) at the left ventricular outflow tract and left ventricular ejection fraction. Changes in norepinephrine and dobutamin dosage during this period were also documented. The decision to explant ECMO was based on clinical tolerance, hemodynamic stability and echocardiographic parameters during the weaning trial.

## Statistical Analysis


Baseline clinical, demographic and hemodynamic characteristics were summarized for the overall study population (n = 50). One patient was excluded from the analysis due to being under legal guardianship. Categorical variables were reported as counts and percentages, while continuous variables were expressed as medians and interquartile ranges (IQR). The normality of continuous variables was assessed visually using histograms.

To explore the distribution of ADRB1 and ADRB2 expression over time in relation to clinical outcomes, boxplots were generated at three timepoints (implantation, day 3–5, and explantation). To evaluate the temporal dynamics of ADRB1 and ADRB2 expression across clinical outcomes, we used linear mixed-effects models with time, outcome group (ECMO weaning, bridge to LVAD/transplant, or death), and their interaction as fixed effects. Random intercepts and slopes for time were included to account for intra-patient variability. When appropriate, receptor expression values were log10-transformed. Interaction terms were tested using likelihood ratio tests between full and reduced models, and Type III ANOVA with Kenward-Roger approximation was used for fixed effects.


To assess the association between ADRB1 and ADRB2 expression at the time of ECMO weaning and left ventricular outflow tract velocity-time integral (VTI) measured at 1.5 L/min ECMO flow, patients were stratified according to a VTI threshold of 12 cm. Mann–Whitney U tests were used to compare log-transformed ADRB expression between the two groups (≤12 cm vs >12 cm). Results were visualized using boxplots.

#FONCTION

```{r,include=FALSE}
source("FUNCTIONS/Examples - RCS effect + interaction cont x factor + check normality 181224.R")
source("FUNCTIONS/Plot_cytokine.R")
```

#DATA LOAD

```{r,include=FALSE}
#ADR LYMPHOCYTES
fichier <- "DATA/df_i_stabilized.xlsx"
feuilles <- excel_sheets(fichier)
data_list <- lapply(feuilles, function(feuille) {
  read_excel(fichier, sheet = feuille)
})


ADR1_lympho <- data_list[[1]] %>%
  select( "Patient","Jour",`Paramètre (Gate)`, `%Gated`)%>%
  rename(value = `%Gated`,
         parametre =`Paramètre (Gate)`)%>%
  mutate(parametre = case_when(parametre == "CD3+/CD4+" ~ "T4",
                               
                              parametre == "ADR1 (CD3+/CD4+)" ~ "ADR1L",
                               
                              parametre == "INFg+ (CD3+ CD4+)" ~ "L_TH1",
                              parametre == "IL4+ (CD3+ CD4+)" ~ "L_TH2",
                              parametre == "IL4+ INFg+ (CD3+ CD4+)" ~ "mixte",
                              
                              parametre == "ADR1 (INFg+)" ~ "ADR1L_TH1",
                              parametre == "ADR1 (IL4+)" ~ 
"ADR1L_TH2",
                              parametre == "ADR1 (IL4+ INFg+)" ~ "ADR1L_mixte",
                              
                              parametre == "IL17+ (CD3+ CD4+)" ~ "L_IL17",
                              parametre == "IL17+ INFg+ (CD3+ CD4+)" ~ "L_IL17_pathogen",
                              
                              parametre == "ADR1 (IL17+)" ~ "L_ADR1L_IL17",
                              parametre == "ADR1 (IL17+ INFg+)" ~ "L_ADR1L_IL17_pathogen",
                              
                               parametre == "IL17+ INFg+ (CD3+ CD4+)" ~ "L_IL17_pathogen",
                               
                               T~parametre),
         ID =str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2"),
         value = as.numeric(value))%>%
  pivot_wider(
    names_from = c("parametre","Jour"),
    values_from = "value",
    values_fn = mean,  
    values_fill = NA
  )%>%
    filter(ID!="12-AA")

#CHECK AK OK


ADR2_lympho <- data_list[[2]] %>%
  select( "Patient","Jour",Gate, `%Gated`)%>%
  rename(value = `%Gated`,
         parametre = Gate)%>%
  mutate(parametre = case_when(
                              parametre == "ADR2 (CD3+/CD4+)" ~ "ADR2L",
                               
                            
                              parametre == "ADR2 (INFg+)" ~ "ADR2L_TH1",
                              parametre == "ADR2 (IL4+)" ~ "ADR2L_TH2",
                              parametre == "ADR2 (IL4+ INFg+)" ~ "ADR2L_mixte",
                              
                              
                              parametre == "ADR2 (IL17+)" ~ "L_ADR2L_IL17",
                              parametre == "ADR2 (IL17+ INFg+)" ~ "L_ADR2L_IL17_pathogen",
                              
                               
                               T~parametre),
         ID =str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2"),
         value = as.numeric(value))%>%
  pivot_wider(
    names_from = c("parametre","Jour"),
    values_from = "value",
    values_fn = mean,  
    values_fill = NA
  )%>%
    filter(ID!="12-AA")


#CHECK AK OK

##Add Monocytes

fichier_mono <- "DATA/monocytes.xlsx"
feuilles_mono <- excel_sheets(fichier_mono)
data_mono <- lapply(feuilles_mono, function(feuille_mono) {
  read_excel(fichier_mono, sheet = feuille_mono)
})

ADR1_mono <- data_mono[[1]] %>%
  select("Patient", "Jour","Paramètre (Gate)", "%Gated") %>%
  rename(value = `%Gated`,
         parametre = "Paramètre (Gate)") %>%
  mutate(parametre= case_when(parametre == "ADR1 (Monocytes)"~"M_ADR1",
                              parametre == "IL1+ (Monocytes)"~"M_IL1",
                              parametre == "IL10+ (Monocytes)"~"M_IL10",
                              parametre == "TNF+ (Monocytes)"~"M_TNF",
                              T~parametre                              ),
    # Create clean ID and normalize 'Jour'
    ID = str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2")
  ) %>%
  select(ID, Jour,parametre,value )%>%
  pivot_wider(
    names_from = c("parametre","Jour"),
    values_from = "value",
    values_fn = mean,
    values_fill = NA
  ) %>%
    filter(ID!="12-AA")
#CHECK AK OK

ADR2_mono <- data_mono[[2]] %>%
  select("Patient", "Jour","Paramètre (Gate)", "%Gated") %>%
  rename(value = `%Gated`,
         parametre = "Paramètre (Gate)") %>%
mutate(parametre= case_when(parametre == "ADR2 (Monocytes)"~"M_ADR2",T~parametre),
    # Create clean ID and normalize 'Jour'
    ID = str_replace(Patient, "Patient (\\d+) (\\w+)", "\\1-\\2")
  )%>%
  filter(parametre=="M_ADR2")%>%
    select(ID, Jour,parametre,value )%>%
  # Reshape from long to wide format
  pivot_wider(
    names_from = c("parametre","Jour"),
    values_from = "value",
    values_fn = mean,
    values_fill = NA
  ) %>%
    filter(ID!="12-AA")
#CHECK AK OK

df_list_1 <- lst(ADR1_lympho, ADR2_lympho, ADR1_mono, ADR2_mono)

# COUNT VALID ID
count_valid_ID <- function(data, id_col = "ID") {
  # Fonction qui compte les ID non-NA dans un seul data.frame
  count_one <- function(df) {
    df %>%
      mutate(
        ID_num = as.integer(str_remove(.data[[id_col]], "-.*")),
        ID_CAT = if_else(!is.na(ID_num), 1L, 0L)
      ) %>%
      summarise(n_valid = sum(ID_CAT, na.rm = TRUE)) %>%
      pull(n_valid)
  }
    imap_dfr(
      data,
      ~ tibble(
          dataset  = .y,
          n_valid  = count_one(.x)
        ),
      .id = NULL
    )
  }

count_valid_ID(df_list_1)

df_1 <- reduce(df_list_1, full_join, by = "ID")%>%
  mutate(any_non_na = as.integer(
      rowSums(
        !is.na( select(., starts_with("ADR")) ),
        na.rm = TRUE       
      ) > 0                  # true if at least one non NA
    )
  )

#IDENTIFY WHICH ID NOT PRESENT IN ONE AND PRESENT IN OTHER
id_presence <- imap_dfr(df_list_1,           
  ~ tibble(ID      = .x$ID,   
           dataset = .y)) %>%  
  mutate(present = 1L) %>%     
  distinct() %>%               
  pivot_wider(
    names_from   = dataset, 
    values_from  = present,    
    values_fill  = list(present = 0L)
  )
diff_IDs <- id_presence %>%
  filter(if_any(-ID, ~ .x == 0))


DATA <- read_delim("DATA/ADRECMO_DATA.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)%>%
  mutate(nom = str_to_upper(nom),
         prenom =str_to_upper(prenom),
         ID = paste0(numero,"-",nom, prenom))%>%
    filter(ID != "12-NANA")

#CHECK AK OK
df_list_2 <- lst(df_1,DATA)

df_2 <- reduce(df_list_2, left_join, by = "ID")

#CHECK AK OK

# --- Constantes et chemins ---
fichier_cyto <- "DATA/cytokines.xlsx"
feuille_idx  <- 7  # on lit la 7e feuille

# --- Variables attendues ---
ck_vars <- c(
  "Sample ID number",
  "[IL-33] in pg/mL","[IL1b] in pg/mL","[IL2] in pg/mL","[IL4] in pg/mL",
  "[IL5] in pg/mL","[IL6] in pg/mL","[IL8/CXCL8]  in pg/mL","[IL10] in pg/mL",
  "[GDF-15] in pg/mL","[IL12p70] in pg/mL","[IL17A/CTLA-8] in pg/mL",
  "[IFNg] in pg/mL","[TNFa] in pg/mL","[Granzyme B]  in pg/mL"
)

# --- Fonctions utilitaires ---
normalize_jour <- function(sample_id) {
  raw <- sample_id %>%
    str_extract("J[A-Z0-9\\-\\.]+") %>%
    str_to_upper() %>%
    str_replace_all("-", "_") %>%
    str_replace_all("\\.", "")
  case_when(
    raw %in% c("J3","J4","J5","J3_5","J3_J5") ~ "J3_J5",
    raw %in% c("JS","JSEVRAGE")               ~ "JS",
    raw == "J0"                                ~ "J0",
    TRUE                                       ~ NA_character_
  )
}

clean_measure_names <- function(x) {
  x %>%
    str_remove_all("\\[|\\]") %>%
    str_remove_all("\\s+in\\s+pg/mL") %>%
    str_squish() %>%
    str_replace_all("\\s+", "")
}

to_numeric_safe <- function(x) {
  x %>%
    as.character() %>%
    str_replace_all(",", ".") %>%
    str_remove_all("\\*") %>%
    str_replace_all("OOR.*|<.*|undetectable|low|LOQ|ND", "0.0000001") %>%
    as.numeric()
}

# --- Vérifications d’entrée ---
all_cols <- names(read_excel(fichier_cyto, sheet = feuille_idx, n_max = 0))
stopifnot(all(ck_vars %in% all_cols))

# --- 1) Lecture de la feuille cytokines (7) ---
df_cyto_raw <- read_excel(fichier_cyto, sheet = feuille_idx) %>%
  select(all_of(ck_vars))

# --- 2) Préparation / nettoyage ---
df_ids <- df_2 %>%
  select(ID) %>%
  mutate(ID_num = str_extract(ID, "^\\d{1,2}") %>%
           as.integer() %>%
           as.character())

df_cyto_clean <- df_cyto_raw %>%
  rename(SampleID = `Sample ID number`) %>%
  mutate(
    ID_num = str_extract(SampleID, "\\d{2}") %>%
      as.integer() %>%
      as.character(),
    Jour   = normalize_jour(SampleID)
  ) %>%
  left_join(df_ids, by = "ID_num") %>%
  select(-ID_num) %>%
  rename_with(clean_measure_names, .cols = -c(SampleID, ID, Jour)) %>%
  mutate(across(-c(SampleID, ID, Jour), to_numeric_safe))

# --- 3) Reshape long -> wide ---
df_cyto_long <- df_cyto_clean %>%
  select(-SampleID) %>%
  filter(!is.na(ID), !is.na(Jour)) %>%
  pivot_longer(
    cols      = -c(ID, Jour),
    names_to  = "cytokine",
    values_to = "value"
  ) %>%
  mutate(var_name = paste0(cytokine, "_", Jour)) %>%
  select(ID, var_name, value) %>%
  pivot_wider(names_from = var_name, values_from = value)

# --- 4) Fusion finale ---
df <- df_2 %>%
  left_join(df_cyto_long, by = "ID")

# --- 5) Vérification optionnelle ---
verif <- read_excel("DATA/ADRECMO_Verif.xlsx") %>%
  mutate(
    Initiales = sub("-", "", Initiales),
    ID        = paste0(`N° patient`, "-", Initiales) %>%
      str_remove("^0+")
  ) %>%
  rename(cause = `Origine du choc cardiogénique`) %>%
  select(ID, cause, CA)

df <- df %>%
  left_join(verif, by = "ID")

# --- 6) Sous-table bio + mapping outcomes ---
df_bio <- df %>%
  select(
    ID, Outcome,
    starts_with("T4_"),
    starts_with("ADR1L_"),
    starts_with("ADR2L_"),
    starts_with("L_TH1_"),
    starts_with("L_TH2_"),
    starts_with("mixte_"),
    starts_with("bINFg"),
    starts_with("IL"),
    starts_with("IFNg"),
    starts_with("TNF"),
    starts_with("GDF-15"),
    starts_with("GranzymeB"),
    starts_with("M_"),
    starts_with("L_"),
    starts_with("mix")
  ) %>%
  mutate(
    Outcome = case_when(
      Outcome %in% c(2, 3) ~ "Bridge to Transplant or LVAD",
      Outcome == 1         ~ "ECMO Weaning",
      Outcome == 4         ~ "Death",
      TRUE                 ~ as.character(Outcome)
    )
  )
```

# TIMEPOINT CHECK OF THE BLOOD SAMPLE AT DAY 0

```{r,include=TRUE}
# Blood sample at day 0 before ECMO implant?

df %>%
  select(J0_date, j0_bilan_date) %>%
  distinct() %>%
  slice(1:15)

df <- df %>%
  mutate(
    J0_date = as.Date(J0_date, format = "%d.%m.%Y"),
    j0_bilan_date = as.Date(j0_bilan_date, format = "%d.%m.%Y"),
    bilan_after_ecmo = case_when(
      is.na(J0_date) | is.na(j0_bilan_date) ~ NA_character_,
      j0_bilan_date > J0_date ~ "Yes",
      TRUE ~ "No"
    )
  )

table(df$bilan_after_ecmo, useNA = "ifany")
#CHECK AK OK

df %>%
  filter(bilan_after_ecmo == "Yes") %>%
  select(ID, j0_bilan_date, J0_date, bilan_after_ecmo)

#CHECK AK OK


df_clean <- df %>%
  mutate(
    j0_bilan_date = as.Date(j0_bilan_date, format = "%d.%m.%Y"),
    J0_date = as.Date(J0_date, format = "%d.%m.%Y"),
    datetime_bilan = as.POSIXct(paste(j0_bilan_date, as.character(j0_bilan_heure)), format = "%Y-%m-%d %H:%M", tz = "UTC"),
    datetime_ecmo  = as.POSIXct(paste(J0_date, as.character(J0_heure)), format = "%Y-%m-%d %H:%M", tz = "UTC"),
    time_diff_mins = as.numeric(difftime(datetime_bilan, datetime_ecmo, units = "mins"))
  ) %>%
  filter(!is.na(time_diff_mins))


df_clean %>%
    mutate(time_diff_hours = time_diff_mins / 60) %>%
  summarise(
    mean_minutes = mean(time_diff_hours),
    sd_minutes = sd(time_diff_hours),
    min = min(time_diff_hours),
    max = max(time_diff_hours)
  )

```

Day-0 blood samples were collected on average 3.47 hours (SD 2.43 hours) before ECMO implantation, ranging from -11 hours before to the exact time of ECMO cannulation.

# DATA Management

```{r,include=TRUE}
df <- df %>%
  mutate(
    Temp_D0 = round(Temp_D0, 1),
    Age = as.numeric(Age),
    Gender = case_when(
      Gender == 0 ~ "Men",
      Gender == 1 ~ "Women",
      TRUE ~ as.character(Gender)
    ),
    
    Preecmo_tte_diam_LV = Preecmo_tte_diam_LV * 10,
    
    Outcome = case_when(
      Outcome == 1 ~ "ECMO Weaning",
      Outcome == 2 ~ "Bridge to Transplant",
      Outcome == 3 ~ "Bridge to LVAD",
      Outcome == 4 ~ "Death",
      TRUE ~ as.character(Outcome)
    ),

    Pulsepressure_D0 = PAS_D0 - PAD_D0,
    

    outcome_date = str_replace_all(outcome_date, "\\.", "/"),
    icu_admiss_date = str_replace_all(icu_admiss_date, "\\.", "/"),
    icu_discharge_date = str_replace_all(icu_discharge_date, "\\.", "/"),

    deces_date = dmy(deces_date),
    icu_admiss_date = dmy(icu_admiss_date),
    icu_discharge_date = dmy(icu_discharge_date),
    date_levo = dmy(date_levo),
    ecmo_start_date = dmy(ecmo_start_date),
    ecmo_stop_date = dmy(ecmo_stop_date),
    outcome_date = case_when(is.na(deces_date)~ icu_admiss_date + 90,
                             T~deces_date),

    diff_days = time_length(interval(icu_admiss_date, outcome_date), "days"),
    Time_hosp = time_length(interval(icu_admiss_date, icu_discharge_date), "days"),
    as.numeric(icu_discharge_date - icu_admiss_date),
    Time_ecmo = time_length(interval(ecmo_start_date, ecmo_stop_date), "days"),
    Time_levo = time_length(interval(ecmo_start_date, date_levo), "days"),
    jsev_date = dmy(jsev_date),
    Time_weaning =time_length(interval(ecmo_start_date, jsev_date), "days"),
    Levo_before_ecmo_end = case_when(
      Levosimendan == 1 &
        date_levo     >= ecmo_start_date &
        date_levo     <= ecmo_stop_date ~ 1L,
      TRUE ~ 0L),

    ADR1L_J0_median = case_when(
      ADR1L_J0 > median(ADR1L_J0, na.rm = TRUE) ~ "High",
      ADR1L_J0 <= median(ADR1L_J0, na.rm = TRUE) ~ "Low"
    ),
    ADR2L_J0_median = case_when(
      ADR2L_J0 > median(ADR2L_J0, na.rm = TRUE) ~ "High",
      ADR2L_J0 <= median(ADR2L_J0, na.rm = TRUE) ~ "Low"
    ),

    M_ADR1_J0_median = case_when(
      M_ADR1_J0 > median(M_ADR1_J0, na.rm = TRUE) ~ "High",
      M_ADR1_J0 <= median(M_ADR1_J0, na.rm = TRUE) ~ "Low",
      TRUE ~ NA_character_
    ),
    M_ADR2_D0_median = case_when(
      M_ADR2_J0 > median(M_ADR2_J0, na.rm = TRUE) ~ "High",
      M_ADR2_J0 <= median(M_ADR2_J0, na.rm = TRUE) ~ "Low",
      TRUE ~ NA_character_
    ),

    Betablocker = case_when(
      Betablocker == 1 ~ "YES",
      Betablocker == 0 ~ "NO"
    ),

    dose_tot_dobu_yes_no = droplevels(as.factor(case_when(
      dose_tot_dobu > 0 ~ "YES",
      dose_tot_dobu == 0 ~ "NO"
    ))),

    levo_in_icu = case_when(
      Levosimendan == 1 & Time_levo >= 0 ~ "Yes",  
      Levosimendan == 1 & Time_levo < 0 ~ "No",
      Levosimendan == 0 ~ "No"
    ),

    Levosimendan = case_when(
      Levosimendan == 1 ~ "YES",
      Levosimendan == 0 ~ "NO",
      TRUE ~ NA_character_ 
    ),
    ische = relevel(as.factor(cause), ref=c("Non ischémique")),
    mean_NAD_24H = NADcum_D0*1000/Weight/3600,
    mean_DOB_24H = DOBUcum_D0*1000/Weight/3600
  )

#CHECK AK OK
var.cat <- c("Gender", "HTN", "DM", "Immunodepression", "CKD", "Neurologic_deficit", "Chronic_respiratory_disease", "HF", "Cardiac_arrest_before_canul", "cause","ische", "IABP_D0", "Intubation", "EER_D0", "Outcome", "Betablocker", "Alphablocker", "Levosimendan", "j90_deces", "j28_deces")

var.cont <- c("Age", "BMI", "PAS_D0", "PAD_D0", "PAM_D0", "Pulsepressure_D0", "HR_D0", "Temp_D0", "Preecmo_tte_ef", "Preecmo_tte_vtiao", "mean_NAD_24H", "mean_DOB_24H", "pH_D0", "Sao2_D0", "Paco2_D0", "Lact_D0", "Hco3_D0", "Creat_D0", "Urea_D0", "ALAT_D0", "ASAT_D0", "Bili_D0", "PT_D0", "Tropo_i_hs_D0", "Ntprobnp_D0", "DPP3_D0", "Plq_D0", "Lenght_eer", "Lenght_vm", "Time_hosp", "Time_ecmo")

var.tot <- c(var.cat, var.cont)

```

# TABLE 1: Characteristics of the population

```{r,include=FALSE}

T1 <- df %>%
  dplyr::select(all_of(var.tot))%>%
  mutate(across(all_of(var.cont), as.numeric), 
         across(all_of(var.cat), as.factor)
         )


## Table 1 standard

table1 <- CreateTableOne(vars = var.tot, factorVars = var.cat, data =T1) 
table1 <- print(table1,
                nonnormal =var.cont,
                 contDigits = 1, showAllLevels = F)

table1_df <- as.data.frame(table1)
table1_df$Variables <- row.names(table1_df)

row.names(table1_df)<-NULL
table1_df <- table1_df[, c(2,1)]

T1_n <- T1%>%
  summarise(across(everything(), ~ sum(is.na(.))))%>%
  pivot_longer(cols= everything(),
    values_to = "n_missing",
    names_to = "ID")

table1_df1 <- table1_df %>%
  mutate(ID = sub("\\(median \\[IQR\\]\\)|= 1 \\(\\%\\)|= Women \\(\\%\\)|\\(\\%\\)|= Non ischémique \\(\\%\\)|= ischémique \\(\\%\\)", "",Variables),
         ID = trimws(ID))%>%
  mutate(ID =sub(" = YES","",ID))

table_1_vf <- left_join(table1_df1,T1_n, by="ID")%>%
  select(Variables,n_missing,Overall)

table_1_vf <- table_1_vf%>%
mutate(Variables= str_remove(Variables, " \\(median \\[IQR\\]\\)"))

traduction <- c(
  "n" = "n",
  "Gender = Women (%)" = "Gender = Female (%)",
  "HTN = 1 (%)" = "Hypertension (%)",
  "DM = 1 (%)" = "Diabetes Mellitus (%)",
  "Immunodepression = 1 (%)" = "Immunosuppression (%)",
  "CKD = 1 (%)" = "Chronic Kidney Disease (%)",
  "Neurologic_deficit = 1 (%)" = "Neurological Deficit (%)",
  "Chronic_respiratory_disease = 1 (%)" = "Chronic Respiratory Disease (%)",
  "HF = 1 (%)" = "Heart Failure (%)",
  "Cardiac_arrest_before_canul = 1 (%)" = "Cardiac Arrest Before Cannulation (%)",
  "cause = Non ischémique (%)" = "Non ichemic (%)",
  "ische = ischémique (%)" = "Ischemic (%)",
  "IABP_D0 = 1 (%)" = "Intra-Aortic Balloon Pump (%)",
  "Intubation = 1 (%)" = "Intubation (%)",
  "EER_D0 = 1 (%)" = "Renal Replacement Therapy (%)",
  "Outcome (%)" = "Outcome (%)",
  "   Bridge to LVAD" = "Bridge to LVAD",
  "   Bridge to Transplant" = "Bridge to Transplant",
  "   Death" = "Death in ICU",
  "   ECMO Weaning" = "ECMO Weaning",
  "Betablocker = YES (%)" = "Beta-blocker (%)",
  "Alphablocker = 1 (%)" = "Alpha-blocker (%)",
  "Levosimendan = YES (%)" = "Levosimendan (%)",
  "j90_deces = 1 (%)" = "90-day Mortality (%)",
  "j28_deces = 1 (%)" = "28-day Mortality (%)",
  "Age" = "Age (years)",
  "BMI" = "Body Mass Index (kg/m²)",
  "PAS_D0" = "Systolic Blood Pressure (mmHg)",
  "PAD_D0" = "Diastolic Blood Pressure (mmHg)",
  "PAM_D0" = "Mean Arterial Pressure (mmHg)",
  "Pulsepressure_D0" = "Pulse Pressure (mmHg)",
  "HR_D0" = "Heart Rate (bpm)",
  "Temp_D0" = "Temperature (°C)",
  "Preecmo_tte_ef" = "Pre-ECMO Ejection Fraction (%)",
  "Preecmo_tte_vtiao" = "Pre-ECMO Aortic Velocity Time Integral (cm)",
  "mean_NAD_24H" = "mean Norepinephrine Dose on cannulation day (gamma/kg/min)",
  "mean_DOB_24H" = "mean Dobutamine Dose on cannulation day (gamma/kg/min)",
  "VIS_D0" = "Vasoactive-Inotropic Score (VIS) at Day 0",
  "pH_D0" = "pH",
  "Sao2_D0" = "Oxygen Saturation (%)",
  "Paco2_D0" = "PaCO2 (mmHg)",
  "Lact_D0" = "Lactate (mmol/L)",
  "Hco3_D0" = "Bicarbonate (mmol/L)",
  "Creat_D0" = "Creatinine (µmol/L)",
  "Urea_D0" = "Urea (mg/dL)",
  "ALAT_D0" = "ALT (IU/L)",
  "ASAT_D0" = "AST (IU/L)",
  "Bili_D0" = "Bilirubin (mg/dL)",
  "PT_D0" = "Prothrombin Time (s)",
  "Tropo_i_hs_D0" = "High Sensitivity Troponin I (ng/L)",
  "Ntprobnp_D0" = "NT-proBNP (pg/mL)",
  "DPP3_D0" = "DPP3 (ng/mL)",
  "Plq_D0" = "Platelet Count (10⁹/L)",
  "Lenght_eer" = "Duration of Renal Replacement Therapy (days)",
  "Lenght_vm" = "Duration of Mechanical Ventilation (days)",
  "Time_hosp" = "ICU Length of Stay (days)",
  "Time_ecmo" = "ECMO Duration (days)"
)

table_1_vf <- table_1_vf %>%
  mutate(Variables = recode(Variables, !!!traduction))

order <- c(
  "n",
  # Demographics
  "Age (years)",
  "Gender = Female (%)",
  "Body Mass Index (kg/m²)",

  # Comorbidities
  "Hypertension (%)",
  "Diabetes Mellitus (%)",
  "Heart Failure (%)",
  "Chronic Kidney Disease (%)",
  "Chronic Respiratory Disease (%)",
  "Neurological Deficit (%)",
  "Immunosuppression (%)",
  
  #Cause
  "Non ichemic (%)",
  "Ischemic (%)",

  # Clinical presentation
  "Systolic Blood Pressure (mmHg)",
  "Diastolic Blood Pressure (mmHg)",
  "Mean Arterial Pressure (mmHg)",
  "Pulse Pressure (mmHg)",
  "Heart Rate (bpm)",
  "Temperature (°C)",
  "Cardiac Arrest Before Cannulation (%)",
  "Intra-Aortic Balloon Pump (%)",
  "Intubation (%)",
  "Renal Replacement Therapy (%)",

  # Echocardiography
  "Pre-ECMO Ejection Fraction (%)",
  "Pre-ECMO Aortic Velocity Time Integral (cm)",

  # Pharmacologic support
  "Beta-blocker (%)",
  "Alpha-blocker (%)",
  "mean Norepinephrine Dose on cannulation day (gamma/kg/min)",
  "mean Dobutamine Dose on cannulation day (gamma/kg/min)",
  "Vasoactive-Inotropic Score (VIS) at Day 0",
  "Levosimendan (%)",

  # Laboratory
  "pH",
  "Oxygen Saturation (%)",
  "PaCO2 (mmHg)",
  "Lactate (mmol/L)",
  "Bicarbonate (mmol/L)",
  "Creatinine (µmol/L)",
  "Urea (mg/dL)",
  "ALT (IU/L)",
  "AST (IU/L)",
  "Bilirubin (mg/dL)",
  "Prothrombin Time (s)",
  "High Sensitivity Troponin I (ng/L)",
  "NT-proBNP (pg/mL)",
  "DPP3 (ng/mL)",
  "Platelet Count (10⁹/L)",

  # Outcomes
  "Outcome (%)",
  "Death in ICU",
  "Bridge to LVAD",
  "Bridge to Transplant",
  "ECMO Weaning",
  "Duration of Renal Replacement Therapy (days)",
  "Duration of Mechanical Ventilation (days)",
  "ECMO Duration (days)",
  "ICU Length of Stay (days)",
  "28-day Mortality (%)",
  "90-day Mortality (%)"
)

table_1_vf2 <- table_1_vf %>%
  mutate(Variables = factor(Variables, levels = order)) %>%
  arrange(Variables)%>%
  rename(Missing = n_missing)

table1 <- flextable(as.data.frame(table_1_vf2)) %>% autofit() %>%
      set_caption("Table 1: Characteristics of the population") %>% 
     align(j = c(2:3), align = "center", part = "all")

```

```{r, include=FALSE, eval=F}
doc <- read_docx() %>%
  body_add_flextable(table1)

print(doc, target = "TABLES/Table1_def.docx")
```


```{r}
table1
```

# Table 2a: Hemodynamic parameters on weaning day

```{r, include=FALSE}
## General information at weaning day
df_long <- df %>%
  select(
    ID,
    Time_weaning,
    jsev_ecmo_debit,
    jsev_dobu_cum,
    jsev_NAd_cum,
    jsev_pam,
    jsev_freq,
    jsev_ett_fevg,
    jsev_ett_vmax_s_mit_lat_vg,
    jsev_lact
  ) %>%
  rename(
    `delay to weaning test` = Time_weaning,
    `ECMO flow (l)` = jsev_ecmo_debit,
    `Dobutamine cumulative (mg)` = jsev_dobu_cum,
    `Noradrenaline cumulative (mg)` = jsev_NAd_cum,
    `MAP_baseline (mmHg)` = jsev_pam,
    `HR (bpm)` = jsev_freq,
    `FEVG (%)` = jsev_ett_fevg,
    `Mitral S' (cm/s)` = jsev_ett_vmax_s_mit_lat_vg,
    `Lactate (mmol/L)` = jsev_lact
  ) %>%
  pivot_longer(
    cols = -ID,
    names_to = "Parameter",
    values_to = "Value"
  )

# Define desired parameter order
custom_order <- c(
  "delay to weaning test",
  "ECMO flow (l)",
  "Dobutamine cumulative (mg)",
  "Noradrenaline cumulative (mg)",
  "MAP_baseline (mmHg)",
  "HR (bpm)",
  "FEVG (%)",
  "Mitral S' (cm/s)",
  "Lactate (mmol/L)"
)

# Apply ordering after summarising
table2a <- df_long %>%
  group_by(Parameter) %>%
  summarise(
    n = sum(!is.na(Value)),
    Median = round(median(Value, na.rm = TRUE), 1),
    Q1 = round(quantile(Value, 0.25, na.rm = TRUE), 1),
    Q3 = round(quantile(Value, 0.75, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(`Median [IQR]` = paste0(Median, " [", Q1, "–", Q3, "], n=", n)) %>%
  select(Parameter, `Median [IQR]`) %>%
  slice(match(custom_order, Parameter))  # Reorder according to custom_order
```

```{r}
table2a
```

# Table 2b  hemodynamic parameters during the weaning test

```{r,INCLUDE=F}
# Create new variables for flow condition and unify variable names

df_long <- df %>%
  select(
    ID,
    jsev_epr_sev_t0_3l_itv,
    jsev_epr_sev_t0_3l_pam,
    `jsev_epr_sev_t1_1,5l_itv`,
    `jsev_epr_sev_t1_1,5l_pam`
  ) %>%
  rename(
    `VTI (cm)` = jsev_epr_sev_t0_3l_itv,
    `MAP (mmHg)` = jsev_epr_sev_t0_3l_pam,
    `VTI_1.5L (cm)` = `jsev_epr_sev_t1_1,5l_itv`,
    `MAP_1.5L (mmHg)` = `jsev_epr_sev_t1_1,5l_pam`,
  ) %>%
  pivot_longer(
    cols = -c(ID),
    names_to = "Parameter_raw",
    values_to = "Value"
  ) %>%
  mutate(
    Value = as.numeric(Value),
    Condition = case_when(
      str_detect(Parameter_raw, "1.5L") ~ "1.5L",
      TRUE ~ "3L"
    ),
    Condition = factor(Condition, levels = c("3L", "1.5L")),
    Parameter = str_replace(Parameter_raw, "_1.5L", "")
  )

# Create summary table

table2b <- df_long %>%
  group_by(Parameter, Condition) %>%
  summarise(
    n = sum(!is.na(Value)),
    Median = round(median(Value, na.rm = TRUE), 5),
    Q1 = round(quantile(Value, 0.25, na.rm = TRUE), 5),
    Q3 = round(quantile(Value, 0.75, na.rm = TRUE), 5),
    .groups = "drop"
  ) %>%
  mutate(
    Value_IQR = paste0(Median, " [", Q1, "–", Q3, "]; n=", n)
  ) %>%
  select(Parameter, Condition, Value_IQR) %>%
  pivot_wider(names_from = Condition, values_from = Value_IQR)

TEST<- wilcox.test(Value ~ Condition,
            data = df_long %>% filter(Parameter == "VTI (cm)"))
```


```{r}
table2b
```

No significant difference between VTI at 3 L and 1.5 L flow conditions at weaning day (Wilcoxon test, p = `r format.pval(TEST$p.value, digits=3)`)

# Figure 1: Association between ADRB expressions and outcomes

```{r,include=FALSE}

# ===========================
# DATA MANAGEMENT
# ===========================
F1_1 <- df %>%
  select(ID,ADR1L_J0, ADR1L_J3_J5, ADR1L_JS, Outcome)%>%
  mutate(Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",T~Outcome), levels=c("Death","Bridge to transplant or LVAD","ECMO Weaning")))%>%
  pivot_longer(
    cols = c(ADR1L_J0, ADR1L_J3_J5, ADR1L_JS), 
    names_to = "ADR1L_time", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR1L_time=="ADR1L_J0"~1,
                          ADR1L_time=="ADR1L_J3_J5"~2,
                          ADR1L_time=="ADR1L_JS"~3)),
         value_log = log1p(value))

count_data <- F1_1 %>%
  filter(!is.na(value))%>%
  group_by(ADR1L_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop")%>%
  filter(!is.na(Outcomes))


# ===========================
# Modélisation
# ===========================

# Modèle avec interaction
mod1 <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 | ID),
  data = F1_1
)

# Résumé du modèle
summary(mod1)

# Modèle sans interaction (modèle réduit)
mod_no_interaction <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 | ID),
  data = F1_1
)

# Comparaison des modèles (test de l'interaction)
interact <- anova(mod_no_interaction, mod1)
# Interprétation : p = 0.5842 → interaction non significative

# ===========================
# Tests des effets fixes
# ===========================

# ANOVA avec approximation de Kenward-Roger pour les p-values
a <- anova(mod_no_interaction, ddf = "Kenward-Roger")
print(a)
pvals <- a$`Pr(>F)`
p_time     <- pvals[1]
p_outcomes <- pvals[2]
p_time_fmt     <- format.pval(p_time,     digits = 3)
p_outcomes_fmt <- format.pval(p_outcomes, digits = 3)
label_text  <- paste0("time p = ", p_time_fmt, "\noutcomes p = ", p_outcomes_fmt)

# ===========================
# Vérification des hypothèses
# ===========================

# 1. Diagrammes de diagnostic généraux
plot(mod_no_interaction)  # résidus vs prédictions par groupe

# 2. Résidus vs valeurs ajustées (homoscédasticité)
plot(fitted(mod_no_interaction), residuals(mod_no_interaction),
     xlab = "Valeurs ajustées", ylab = "Résidus",
     main = "Résidus vs ajustés")

# 3. Normalité des résidus
qqnorm(residuals(mod_no_interaction))
qqline(residuals(mod_no_interaction), col = "blue")

# 4. Autocorrélation des résidus (si données longitudinales)
acf(residuals(mod_no_interaction), main = "ACF des résidus")

# ===========================
# Figure
# ===========================
Figure_1_1 <- ggplot(F1_1, aes(x = ADR1L_time, y = value_log, fill = Outcomes)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) + 
  scale_y_continuous(name = "Percentage of T4 lymphocyte expressing ADRB1\n (log 10 scale)") +
  labs(
    title = "A",
    x = "Time"  ) +
  geom_text(data = count_data, aes(x = ADR1L_time, y = min(F1_1$value_log, na.rm = TRUE), 
                                   label = paste0("n=", n), group = Outcomes), 
            position = position_dodge(0.7), size = 4, vjust = 1)+
    scale_x_discrete(labels = c("ADR1L_J0" = "implantation", "ADR1L_J3_J5" = "day 3 to 5", "ADR1L_JS" = "explantation")) +
  scale_fill_manual(values = c(
      "ECMO Weaning" = "#4DAF4A",                   
    "Bridge to transplant or LVAD" = "#377EB8",   
    "Death" = "#F8766D"                           
  )) +
  theme(legend.position = "none") + 
  annotate(
    "text",
    x     = 1,  # ou la position souhaitée sur l'axe x
    y     = max(F1_1$value_log, na.rm = TRUE) * 0.9,
    label = label_text,
    hjust = 0
  )

###############@
F1_1b <- df %>%
  select(ID, L_TH1_J0, L_TH1_J3_J5, L_TH1_JS,L_TH2_J0,L_TH2_J3_J5,L_TH2_JS,Outcome)%>%
    mutate(TH1_TH2_ratio_J0 = L_TH1_J0/L_TH2_J0,
           TH1_TH2_ratio_J3_J5 = L_TH1_J3_J5/L_TH2_J3_J5,
           TH1_TH2_ratio_JS = L_TH1_JS/L_TH2_JS,
           Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",
                                       T~Outcome),
                             levels=c("Death","Bridge to transplant or LVAD","ECMO Weaning")))%>%
  pivot_longer(
    cols = c(TH1_TH2_ratio_J0, TH1_TH2_ratio_J3_J5, TH1_TH2_ratio_JS), 
    names_to = "ADR1L_time", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR1L_time=="TH1_TH2_ratio_J0"~1,
                          ADR1L_time=="TH1_TH2_ratio_J3_J5"~2,
                          ADR1L_time=="TH1_TH2_ratio_JS"~3)),
         value_log = log1p(value))%>%
  filter(!is.na(value))%>%
  select(ID, time,ADR1L_time, value,value_log, Outcomes)

count_data <- F1_1b %>%
  filter(!is.na(value))%>%
  group_by(ADR1L_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop")%>%
  filter(!is.na(Outcomes))


# ===========================
# Modélisation
# ===========================

# Modèle avec interaction
mod1 <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 + time | ID),
  data = F1_1b
)
F1_1b$value_log
# Résumé du modèle
summary(mod1)

# Modèle sans interaction (modèle réduit)
mod_no_interaction <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 + time | ID),
  data = F1_1b
)

# Comparaison des modèles (test de l'interaction)
interact <- anova(mod_no_interaction, mod1)
# Interprétation : p = 0.6249 → interaction non significative

# ===========================
# Tests des effets fixes
# ===========================

# ANOVA avec approximation de Kenward-Roger pour les p-values
a <- anova(mod_no_interaction, ddf = "Kenward-Roger")
print(a)
pvals <- a$`Pr(>F)`
p_time     <- pvals[1]
p_outcomes <- pvals[2]
p_time_fmt     <- format.pval(p_time,     digits = 3)
p_outcomes_fmt <- format.pval(p_outcomes, digits = 3)
label_text  <- paste0("time p = ", p_time_fmt, "\noutcomes p = ", p_outcomes_fmt)

# ===========================
# Vérification des hypothèses
# ===========================

# 1. Diagrammes de diagnostic généraux
plot(mod_no_interaction)  # résidus vs prédictions par groupe

# 2. Résidus vs valeurs ajustées (homoscédasticité)
plot(fitted(mod_no_interaction), residuals(mod_no_interaction),
     xlab = "Valeurs ajustées", ylab = "Résidus",
     main = "Résidus vs ajustés")

# 3. Normalité des résidus
qqnorm(residuals(mod_no_interaction))
qqline(residuals(mod_no_interaction), col = "blue")

# 4. Autocorrélation des résidus (si données longitudinales)
acf(residuals(mod_no_interaction), main = "ACF des résidus")

# 5. Normalité des pentes aléatoires (effets aléatoires sur time)
qqnorm(ranef(mod_no_interaction)$ID[, "time"],
       main = "QQ-plot des pentes aléatoires (time)")
qqline(ranef(mod_no_interaction)$ID[, "time"], col = "blue")


# ===========================
# Figure
# ===========================
Figure_1_1b <- ggplot(F1_1b, aes(x = ADR1L_time, y = value, fill = Outcomes)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +  
  scale_y_log10() +  
  labs(
    title = "A",
    x = "Time",
    y = "Percentage of T4 lymphocyte expressing TH1/TH2\n ",
  ) +
  geom_text(data = count_data, aes(x = ADR1L_time, y =- min(F1_1$value_log, na.rm = TRUE) *0.1, 
                                   label = paste0("n=", n), group = Outcomes), 
            position = position_dodge(0.7), size = 4, vjust = 1)+
    scale_x_discrete(labels = c("ADR1L_J0" = "implantation", "ADR1L_J3_J5" = "day 3 to 5", "ADR1L_JS" = "explantation")) +
  scale_fill_manual(values = c(
      "ECMO Weaning" = "#4DAF4A",                   
    "Bridge to transplant or LVAD" = "#377EB8",   
    "Death" = "#F8766D"                           
  )) +
  theme(legend.position = "none") + 
  annotate(
    "text",
    x     = 1,  # ou la position souhaitée sur l'axe x
    y     = max(F1_1$value_log, na.rm = TRUE) * 0.9,
    label = label_text,
    hjust = 0
  )


#####################
## ADRB2 
#####################

# ===========================
# DATA MANAGEMENT
# ===========================

F1_2 <- df %>%
  select(ID,ADR2L_J0, ADR2L_J3_J5, ADR2L_JS, Outcome)%>%
  mutate(Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",T~Outcome), levels=c("Death","Bridge to transplant or LVAD","ECMO Weaning")))%>%
  pivot_longer(
    cols = c(ADR2L_J0, ADR2L_J3_J5, ADR2L_JS), 
    names_to = "ADR2L", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR2L=="ADR2L_J0"~1,
                          ADR2L=="ADR2L_J3_J5"~2,
                          ADR2L=="ADR2L_JS"~3)),
         value_log = log1p(value))


count_data <- F1_2 %>%
  filter(!is.na(value))%>%
  group_by(ADR2L, Outcomes) %>%
  summarise(n = n(), .groups = "drop")%>%
  filter(!is.na(Outcomes))

# ===========================
# Modélisation
# ===========================

# Modèle avec interaction
mod1 <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 + time | ID),
  data = F1_2
)

# Résumé du modèle
summary(mod1)

# Modèle sans interaction (modèle réduit)
mod_no_interaction <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1 + time | ID),
  data = F1_2
)

# Comparaison des modèles (test de l'interaction)
interact <- anova(mod_no_interaction, mod1)
# Interprétation : p = 0.9579 → interaction non significative

# ===========================
# Tests des effets fixes
# ===========================

# ANOVA avec approximation de Kenward-Roger pour les p-values
a <- anova(mod_no_interaction, ddf = "Kenward-Roger")
print(a)
pvals <- a$`Pr(>F)`
p_time     <- pvals[1]
p_outcomes <- pvals[2]
p_time_fmt     <- format.pval(p_time,     digits = 3)
p_outcomes_fmt <- format.pval(p_outcomes, digits = 3)
label_text  <- paste0("time p = ", p_time_fmt, "\noutcomes p = ", p_outcomes_fmt)


# ===========================
# Vérification des hypothèses
# ===========================

# 1. Diagrammes de diagnostic généraux
plot(mod_no_interaction)  # résidus vs prédictions par groupe

# 2. Résidus vs valeurs ajustées (homoscédasticité)
plot(fitted(mod_no_interaction), residuals(mod_no_interaction),
     xlab = "Valeurs ajustées", ylab = "Résidus",
     main = "Résidus vs ajustés")

# 3. Normalité des résidus
qqnorm(residuals(mod_no_interaction))
qqline(residuals(mod_no_interaction), col = "blue")

# 4. Autocorrélation des résidus (si données longitudinales)
acf(residuals(mod_no_interaction), main = "ACF des résidus")

# 5. Normalité des pentes aléatoires (effets aléatoires sur time)
qqnorm(ranef(mod_no_interaction)$ID[, "time"],
       main = "QQ-plot des pentes aléatoires (time)")
qqline(ranef(mod_no_interaction)$ID[, "time"], col = "blue")

#extrait P values
annot_pvals <- data.frame(
  ADR2L = "ADR2L_J0",
  value_log = max(F1_2$value_log, na.rm = TRUE) * 1.1,
  label = "p[time] == 0.07 * '\n' * p[outcomes] == 0.05"
)

Figure_1_2 <- ggplot(F1_2, aes(x = ADR2L, y = value_log, fill = Outcomes)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +  
  labs(
    title = "B",
    x = "Time",
    y = "Percentage of T4 lymphocyte expressing ADRB2\n(log 1p scale)",
  ) +
  geom_text(data = count_data, aes(x = ADR2L, y = -min(F1_2$value_log, na.rm = TRUE) * 0.01, 
                                   label = paste0("n=", n), group = Outcomes), 
            position = position_dodge(0.7), size = 4, vjust = 1)+
      scale_x_discrete(labels = c("ADR2l_J0" = "implantation", "ADR2l_J3_J5" = "day 3 to 5", "ADR2l_JS" = "explantation"))+
    scale_fill_manual(values = c(
      "ECMO Weaning" = "#4DAF4A",                   
    "Bridge to transplant or LVAD" = "#377EB8",   
    "Death" = "#F8766D"                           
  )) +
  annotate(
    "text",
    x     = 1,  # ou la position souhaitée sur l'axe x
    y     = max(F1_2$value_log, na.rm = TRUE) * 0.9,
    label = label_text,
    hjust = 0
  )

# ===========================
# DATA MANAGEMENT
# ===========================
F1_3 <- df %>%
  select(ID,M_ADR1_J0, M_ADR1_J3_J5, M_ADR1_JS, Outcome)%>%
  mutate(Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",T~Outcome), levels=c("Death","Bridge to transplant or LVAD","ECMO Weaning")))%>%
  pivot_longer(
    cols = c(M_ADR1_J0, M_ADR1_J3_J5, M_ADR1_JS), 
    names_to = "ADR1m_time", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR1m_time=="M_ADR1_J0"~1,
                          ADR1m_time=="M_ADR1_J3_J5"~2,
                          ADR1m_time=="ADR1m_JS"~3)),
         value_log = log1p(value))%>%
  filter(!is.na(value_log))

# Count data for annotation
count_data_m <- F1_3 %>%
  filter(!is.na(value)) %>%
  group_by(ADR1m_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(!is.na(Outcomes))

# ===========================
# Mixed effects model
# ===========================

summary(F1_3$value_log)
sum(is.na(F1_3$value_log))
sum(is.infinite(F1_3$value_log))

# Model with interaction
mod1_m <- lmerTest::lmer(
  value_log ~ time * Outcomes + (1 | ID),
  data = F1_3
)

# Model without interaction
mod_no_interaction_m <- lmerTest::lmer(
  value_log ~ time + Outcomes + (1  | ID),
  data = F1_3
)

# Interaction test
interact_m <- anova(mod_no_interaction_m, mod1_m)
# Interpretation : p = 0.4767 → interaction not significant

# ANOVA for fixed effect (withouth interaction)
a_m <- anova(mod_no_interaction_m, ddf = "Kenward-Roger")
print(a_m)
pvals <- a_m$`Pr(>F)`
p_time     <- pvals[1]
p_outcomes <- pvals[2]
p_time_fmt     <- format.pval(p_time,     digits = 3)
p_outcomes_fmt <- format.pval(p_outcomes, digits = 3)
label_text  <- paste0("time p = ", p_time_fmt, "\noutcomes p = ", p_outcomes_fmt)

# ===========================
# Diagnostic plots
# ===========================
# 1. Residual diagnostic plots
plot(mod_no_interaction_m)

# 2. Residuals vs Fitted
plot(fitted(mod_no_interaction_m), residuals(mod_no_interaction_m),
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")

# 3. Normality of residuals
qqnorm(residuals(mod_no_interaction_m))
qqline(residuals(mod_no_interaction_m), col = "blue")

# 4. Autocorrelation of residuals
acf(residuals(mod_no_interaction_m), main = "ACF of residuals")

# 5. Normality of random intercepts (optional)
qqnorm(ranef(mod_no_interaction_m)$ID[, "(Intercept)"],
       main = "QQ plot of random intercepts (ID)")
qqline(ranef(mod_no_interaction_m)$ID[, "(Intercept)"], col = "blue")

# ===========================
# Figure
# ===========================
Figure_1_3 <- ggplot(F1_3, aes(
    x = ADR1m_time,
    y = value,
    fill = Outcomes,
    group = interaction(ADR1m_time, Outcomes)  
)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +
  #scale_y_log10() +
  labs(
    title = "C",
    x = "Time",
    y = "Percentage of monocytes expressing ADRB1"
  ) +
  geom_text(data = count_data_m, aes(
    x = ADR1m_time,
    y = min(F1_3$value_log[F1_3$value_log > 0], na.rm = TRUE) * 0.2,
    label = paste0("n=", n),
    group = interaction(ADR1m_time, Outcomes)
  ),
  position = position_dodge(0.7),
  size = 4,
  vjust = 1) +
  scale_x_discrete(labels = c(
    "ADR1m_J0" = "implantation",
    "ADR1m_J3_J5" = "day 3 to 5",
    "ADR1m_JS" = "explantation"
  )) +
    scale_fill_manual(values = c(
    "ECMO Weaning" = "#4DAF4A",                   
    "Bridge to transplant or LVAD" = "#377EB8",   
    "Death" = "#F8766D"                           
  )) +
  theme(legend.position = "none") +
  annotate(
    "text",
    x     = 1,  # ou la position souhaitée sur l'axe x
    y     = max(F1_3$value_log, na.rm = TRUE) * 6.5,
    label = label_text,
    hjust = 0
  )

#####################
## ADRB2 (monocytes)
#####################

# ==========================
# DATA MANAGEMENT
# ==========================


# colonnes à analyser
vars_to_plot <- c("M_ADR2_J0", "M_ADR2_J3_J5", "M_ADR2_JS")

# appel de la fonction
plot_density_log10(df, vars_to_plot)
F1_4 <- df %>%
  select(ID,M_ADR2_J0, M_ADR2_J3_J5, M_ADR2_JS, Outcome, Time_ecmo)%>%
  mutate(Outcomes = factor(case_when(Outcome=="Bridge to LVAD"|Outcome=="Bridge to Transplant"~ "Bridge to transplant or LVAD",T~Outcome), levels=c("Death","Bridge to transplant or LVAD","ECMO Weaning")))%>%
  pivot_longer(
    cols = c(M_ADR2_J0, M_ADR2_J3_J5, M_ADR2_JS), 
    names_to = "ADR2m_time", 
    values_to = "value"
  )%>%
  mutate(time = as.numeric(case_when(ADR2m_time=="M_ADR2_J0"~1,
                          ADR2m_time=="M_ADR2_J3_J5"~2,
                          ADR2m_time=="M_ADR2_JS"~3)),
         #value_log = log10(value)         
         )%>%
  filter(!is.na(value))



# ==========================
# Count available data
# ==========================
count_data_m2 <- F1_4 %>%
  group_by(ADR2m_time, Outcomes) %>%
  summarise(n = n(), .groups = "drop")


library(glmmTMB)
mod_gamma1 <- glmmTMB(
  value ~ time * Outcomes + (1 | ID),
  family = Gamma(link="log"),
  data   = F1_4
)
summary(mod_gamma)

mod_gamma2 <- glmmTMB(
  value ~ time + Outcomes + (1 | ID),
  family = Gamma(link="log"),
  data   = F1_4
)
summary(mod_gamma)


# Test interaction
interact_m2 <- anova(mod_gamma1, mod_gamma2)
# Interpretation : p = 0.5997 → interaction not significant

# Fixed effect ANOVA (no interaction)
library(car)

# Type II (pas de correction pour interaction)
a_m2<-Anova(mod_gamma, type = 2)

# Type III (teste chaque effet en présence de tous les autres)
Anova(mod_gamma, type = 3)
print(a_m2)
pvals <- a_m2$`Pr(>Chisq)`
p_time     <- pvals[1]
p_outcomes <- pvals[2]
p_time_fmt     <- format.pval(p_time,     digits = 3)
p_outcomes_fmt <- format.pval(p_outcomes, digits = 3)
label_text  <- paste0("time p = ", p_time_fmt, "\noutcomes p = ", p_outcomes_fmt)

# =
# ==========================
# FIGURE
# ==========================
Figure_1_4 <- ggplot(F1_4, aes(
  x = ADR2m_time, y = value, fill = Outcomes,
  group = interaction(ADR2m_time, Outcomes)
)) +
  geom_boxplot(position = position_dodge(0.7), width = 0.6) +
  #scale_y_log10() +
  labs(
    title = "D",
    x = "Time",
    y = "Percentage of monocytes expressing ADRB2"
  ) +
  geom_text(data = count_data_m2, aes(
    x = ADR2m_time,
    y = min(F1_4$value, na.rm = TRUE),
    label = paste0("n=", n),
    group = interaction(ADR2m_time, Outcomes)
  ),
  position = position_dodge(0.7),
  size = 4,
  vjust = 1) +
  scale_x_discrete(labels = c(
    "ADR2m_J0" = "implantation",
    "ADR2m_J3_5" = "day 3 to 5",
    "ADR2m_JS" = "explantation"
  )) +
    scale_fill_manual(values = c(
      "ECMO Weaning" = "#4DAF4A",                   
    "Bridge to transplant or LVAD" = "#377EB8",   
    "Death" = "#F8766D"                           
  )) +
  theme(legend.position = "none") +
  annotate(
    "text",
    x     = 1, 
    y     = max(F1_4$value, na.rm = TRUE)*0.8,
    label = label_text,
    hjust = 0
  )


Figure1_tot <- Figure_1_1 + Figure_1_2 +Figure_1_3+ Figure_1_4
```

```{r Figure1_tot, fig.width=8, fig.height=6, fig.scale=1.5, dpi=300, fig.align='center'}
Figure1_tot
```

# Figure 2: Association between VTI and ADRB in Lymphocyte at day of weaning

```{r,include=TRUE}
#ADRB1
F2_1_a <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, ADR1L_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB1
mann_whitney_VTI <- wilcox.test(ADR1L_JS ~ VTI_JS, data = F2_1_a)

# Extract and format the p-value
p_value_VTI <- sprintf("%.3f", mann_whitney_VTI$p.value)

count_data <- F2_1_a %>%
  group_by(VTI_JS) %>%
  summarise(n = n())

# Boxplot for ADRB1 with p-value annotation 
Figure2a <- ggplot(F2_1_a, aes(x = VTI_JS, y = log10(ADR1L_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  geom_text(data = count_data,
            aes(x = VTI_JS, y = min(log10(F2_1_a$ADR1_JS), na.rm = TRUE) * 1.25,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "A",
    x = "VTI measured at 1.5 L/min",
    y = "% of lymphocytes expressing ADRB2 at ECMO weaning \n (log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text",
           x = 1.5,
           y = max(log10(F2_1_a$ADR1_JS), na.rm = TRUE),
           label = paste("p:", p_value_VTI),
           size = 5, color = "black", hjust = 0.5)


#ADRB2
F2_2_a <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, ADR2L_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   
df$ADR2l_JS
 # Mann-Whitney test for VTI and ADRB2
mann_whitney_VTI_2 <- wilcox.test(log10(ADR2_JS) ~ VTI_JS, data = F2_2_a)

# Extract and format the p-value
p_value_VTI_2 <- sprintf("%.3f", mann_whitney_VTI_2$p.value)

count_data <- F2_2_a %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")

# Boxplot for ADRB2 with p-value annotation 
Figure2b <- ggplot(F2_2_a, aes(x = VTI_JS, y = log10(ADR2_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L /min",
    y = "% of lymphocytes expressing ADRB2 measured at ECMO weaning \n (log10 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log10(F2_2_a$ADR2_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI_2),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = min(log10(F2_2_a$ADR2_JS), na.rm = TRUE) * 1.25,  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )

Figure2_tot <- Figure2a | Figure2b +
  plot_annotation(
    title = "Association between VTI at weaning and ADRB1/ADRB2 expression in lymphocyte",
    tag_levels = c("A","B")  
  )

```

```{r}
Figure2_tot
```



# Figure 3: Association between VTI and % of expression of ADRB on monocyte at day of weaning

```{r,include=TRUE}
#ADRB1
F3_1 <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, ADR1L_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   
 # Mann-Whitney test for VTI and ADRB1
mann_whitney_VTI <- wilcox.test(log2(ADR1L_JS) ~ VTI_JS, data = F3_1)

# Extract and format the p-value
p_value_VTI <- sprintf("%.3f", mann_whitney_VTI$p.value)

count_data <- F3_1 %>%
  group_by(VTI_JS) %>%
  summarise(n = n())

# Boxplot for ADRB1 with p-value annotation 
Figure3a <- ggplot(F3_1, aes(x = VTI_JS, y = log2(ADR1L_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  geom_text(data = count_data,
            aes(x = VTI_JS, y = -3,
                label = paste0("n=", n)),
            size = 4,
            inherit.aes = FALSE) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "A",
    x = "VTI measured at 1.5 L/min",
    y = "% of lymphocyte expressing ADRB1  measured at ECMO weaning \n (log2 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate("text",
           x = 1.5,
           y = max(log2(F3_1$ADR1L_JS), na.rm = TRUE),
           label = paste("p:", p_value_VTI),
           size = 5, color = "black", hjust = 0.5)


#ADRB2
F3_2 <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, ADR2L_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB2
mann_whitney_VTI_2 <- wilcox.test(log2(ADR2L_JS) ~ VTI_JS, data = F3_2)

# Extract and format the p-value
p_value_VTI_2 <- sprintf("%.3f", mann_whitney_VTI_2$p.value)

count_data <- F3_2 %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")

# Boxplot for ADRB2 with p-value annotation 
Figure3b <- ggplot(F3_2, aes(x = VTI_JS, y = log2(ADR2L_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L /min",
    y = "% of lymphocyte expressing ADRB2 at ECMO weaning \n (log2 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log2(F3_2$ADR2L_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI_2),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = min(log2(F3_2$ADR2L_JS), na.rm = TRUE) * 1.25,  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )

Figure3_tot <- Figure3a | Figure3b +
  plot_annotation(
    title = "Association between VTI at weaning and % of monocytes expressing  ADRB",
    tag_levels = c("A","B")  
  )

```

```{r}
Figure3_tot
```

```{r}
F3_3 <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, M_ADR1_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB2
mann_whitney_VTI_3 <- wilcox.test(log2(M_ADR1_JS) ~ VTI_JS, data = F3_3)

# Extract and format the p-value
p_value_VTI_2 <- sprintf("%.3f", mann_whitney_VTI_2$p.value)

count_data <- F3_3 %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")
# Boxplot for ADRB2 with p-value annotation 
Figure3c <- ggplot(F3_3, aes(x = VTI_JS, y = log2(M_ADR1_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L /min",
    y = "% of monocyte expressing ADRB2 at ECMO weaning \n (log2 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log2(F3_3$M_ADR1_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI_2),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = min(log2(F3_3$M_ADR1_JS), na.rm = TRUE) * 1.25,  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )


F3_4 <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, M_ADR2_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB2
mann_whitney_VTI_4 <- wilcox.test(log2(M_ADR2_JS) ~ VTI_JS, data = F3_4)

# Extract and format the p-value
p_value_VTI_4 <- sprintf("%.3f", mann_whitney_VTI_4$p.value)

count_data <- F3_4 %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")
# Boxplot for ADRB2 with p-value annotation 
Figure3d <- ggplot(F3_4, aes(x = VTI_JS, y = log2(M_ADR2_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L /min",
    y = "% of monocyte expressing ADRB2 at ECMO weaning \n (log2 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log2(F3_4$M_ADR2_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI_4),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = min(log2(F3_4$M_ADR2_JS), na.rm = TRUE) * 1.25,  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )

```


```{r}

F3_5 <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, L_TH2_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB2
mann_whitney_VTI_5 <- wilcox.test(log2(L_TH2_JS) ~ VTI_JS, data = F3_5)

# Extract and format the p-value
p_value_VTI_5 <- sprintf("%.3f", mann_whitney_VTI_5$p.value)

count_data <- F3_5 %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")
# Boxplot for TH2 with p-value annotation 

Figure3d <- ggplot(F3_5, aes(x = VTI_JS, y = log2(L_TH2_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L /min",
    y = "% of LT TH2 expressing at ECMO weaning \n (log2 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log2(F3_5$L_TH2_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI_5),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = min(log2(F3_5$L_TH2_JS), na.rm = TRUE) * 1.25,  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )
```


```{r}
F3_6 <- df %>%
select(`jsev_epr_sev_t1_1,5l_itv`, L_TH1_JS)%>%
  mutate(
    VTI_JS = case_when(
      `jsev_epr_sev_t1_1,5l_itv` > 12 ~ ">12 cm",
      `jsev_epr_sev_t1_1,5l_itv` <= 12 ~ "≤12 cm"
    )
  )%>%
  na.omit()
   

 # Mann-Whitney test for VTI and ADRB2
mann_whitney_VTI_6 <- wilcox.test(log2(L_TH1_JS) ~ VTI_JS, data = F3_6)

# Extract and format the p-value
p_value_VTI_6 <- sprintf("%.3f", mann_whitney_VTI_6$p.value)

count_data <- F3_6 %>%
  group_by(VTI_JS) %>%
  summarise(n = n(), .groups = "drop")
# Boxplot for ADRB2 with p-value annotation 
Figure3e <- ggplot(F3_6, aes(x = VTI_JS, y = log2(L_TH1_JS), fill = VTI_JS)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.7, position = position_jitter(width = 0.1)) +
  scale_fill_manual(values = c("≤12 cm" = "#0072B2", ">12 cm" = "#D55E00")) +
  labs(
    title = "B",
    x = "VTI measured at 1.5L /min",
    y = "% of LT TH1 expressing at ECMO weaning \n (log2 scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  annotate(
    "text",
    x = 1.5,
    y = max(log2(F3_6$L_TH1_JS), na.rm = TRUE),
    label = paste("p:", p_value_VTI_4),
    size = 5,
    color = "black",
    hjust = 0.5
  ) +
  geom_text(
    data = count_data,
    aes(
      x = VTI_JS,
      y = max(log2(F3_6$L_TH1_JS), na.rm = TRUE),  
      label = paste0("n=", n)
    ),
    inherit.aes = FALSE,
    size = 4
  )
```


# Figure 6: Survival \~ ADR in Lymphocyte

```{r,include=TRUE}

# ADRB1
km_fit <- survfit(Surv(diff_days, j90_deces) ~ ADR1_D0_median, data = df)
summary(km_fit)

Figure_6 <- ggsurvplot(km_fit, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 90),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Figure_6 <- Figure_6 + ggtitle("90-day Survival Curves for ADRB1")

# ADRB2
km_fit <- survfit(Surv(diff_days, j90_deces) ~ ADR2_D0_median, data = df)

Figure_6.1 <- ggsurvplot(km_fit, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 90),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),  
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Figure_6.1 <- Figure_6.1 + ggtitle("90-day Survival Curves for ADRB2")

# Combine the plots (ADR1 and ADR2) side by side with the risk tables
Figure_6_combined <- plot_grid(Figure_6$plot, Figure_6$table, ncol = 1, align = "v", rel_heights = c(3, 1))
Figure_6.1_combined <- plot_grid(Figure_6.1$plot, Figure_6.1$table, ncol = 1, align = "v", rel_heights = c(3, 1))

# Remove titles from individual plots
Figure_6_combined <- Figure_6_combined + theme(plot.title = element_blank())
Figure_6.1_combined <- Figure_6.1_combined + theme(plot.title = element_blank())

# Combine both survival plots (ADR1 and ADR2) together with a title
Figure6_tot <- plot_grid(Figure_6_combined, Figure_6.1_combined, ncol = 2, align = "h")

# Add a title to the combined figure
Figure6_tot <- Figure6_tot + plot_annotation(title = "90-day Survival Curves for % of Lymphocytes expressing ADRB")

```

```{r}
Figure6_tot
```

# Figure 6m: Survival \~ ADR in Monocyte

```{r,include=TRUE}

df_surv_m1 <- df %>%
  filter(!is.na(ADR1m_D0_median), !is.na(diff_days_J28), !is.na(Outcome_censored_28))

# ADRB1 on Monocytes
km_fit_m1 <- survfit(Surv(diff_days, j90_deces) ~ ADR1m_D0_median, data = df)


Fig_m1 <- ggsurvplot(km_fit_m1, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 90),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Fig_m1 <- Fig_m1 + ggtitle("90-day Survival Curves for ADRB1")

# ADRB2 on Monocytes
km_fit_m2 <- survfit(Surv(diff_days, j90_deces) ~ ADR2m_D0_median, data = df)

Fig_m2 <- ggsurvplot(km_fit_m2, data = df, 
  pval = TRUE,               
  pval.coord = c(10, 0.1),   
  conf.int = FALSE,           
  risk.table = TRUE,         
  risk.table.height = 0.2,   
  risk.table.y.text = TRUE,  
  risk.table.title = "Number at Risk (number censored)",  
  xlim = c(0, 90),         
  break.time.by = 7,
  legend.title = " ",       
  palette = c("#E63946", "#457B9D"),  
  ggtheme = theme_minimal(),
  legend.labs = c("High", "Low")
)

Fig_m2 <- Fig_m2 + ggtitle("28-day Survival Curves for ADRB2")

# Combine plots
Fig_m1_combined <- plot_grid(Fig_m1$plot, Fig_m1$table, ncol = 1, align = "v", rel_heights = c(3, 1))
Fig_m2_combined <- plot_grid(Fig_m2$plot, Fig_m2$table, ncol = 1, align = "v", rel_heights = c(3, 1))

Fig_m1_combined <- Fig_m1_combined + theme(plot.title = element_blank())
Fig_m2_combined <- Fig_m2_combined + theme(plot.title = element_blank())

Fig_monocyte_survival <- Fig_m1_combined + Fig_m2_combined +
  plot_annotation(title = "90-day Survival Curves for % of monocytes expressing ADRB")
```

```{r}
Fig_monocyte_survival
```

## Statistical analysis

To assess the prognostic significance of baseline β-adrenergic receptor expression, we stratified patients based on the median value of ADRB1 and ADRB2 measured at ECMO initiation (D0). Survival analysis was performed using Kaplan–Meier curves and the log-rank test to compare 28-day survival between patients with “High” vs “Low” expression. Patients were censored at the time of ECMO weaning, heart transplantation or LVAD implantation. 

## Results

Although the differences did not reach statistical significance, a trend was observed indicating that patients with higher ADRB expression in both lymphocytes and monocytes at ECMO initiation had lower 28-day survival probability. This pattern suggests a potential association between adrenergic receptor activation and worse short-term outcomes.

# Cytokines

```{r}
plot_cytokine <- function(df, cytokine_name) {
  
  # Colomn name
  col_J0 <- paste0(cytokine_name, "_J0")
  col_J3_J5 <- paste0(cytokine_name, "_J3_J5")
  col_JS <- paste0(cytokine_name, "_JS")

  # 1. dataset
  data_plot <- df %>%
    select(ID, Outcome, all_of(c(col_J0, col_J3_J5, col_JS))) %>%
    mutate(
      Outcomes = factor(case_when(
        Outcome %in% c("Bridge to LVAD", "Bridge to Transplant") ~ "Bridge to transplant or LVAD",
        TRUE ~ as.character(Outcome)
      ), levels = c("Death", "Bridge to transplant or LVAD", "ECMO Weaning"))
    ) %>%
    pivot_longer(
      cols = c(all_of(c(col_J0, col_J3_J5, col_JS))),
      names_to = "cyto_time",
      values_to = "value"
    ) %>%
    mutate(
      time = case_when(
        cyto_time == col_J0 ~ 1,
        cyto_time == col_J3_J5 ~ 2,
        cyto_time == col_JS ~ 3,
        TRUE ~ NA_real_
      ),
      value_log = log1p(value)
    )

  # 2. n
  count_data <- data_plot %>%
    filter(!is.na(value)) %>%
    group_by(cyto_time, Outcomes) %>%
    summarise(n = n(), .groups = "drop") %>%
    filter(!is.na(Outcomes))

  # 3. Models
  mod_no_interaction <- lmerTest::lmer(
    value_log ~ time + Outcomes + (1 + time | ID),
    data = data_plot
  )

  p_anova <- anova(mod_no_interaction, ddf = "Kenward-Roger")
  p_time <- format.pval(p_anova["time", "Pr(>F)"], digits = 3, eps = .001)
  p_outcome <- format.pval(p_anova["Outcomes", "Pr(>F)"], digits = 3, eps = .001)

  # 4. Plot
  p <- ggplot(data_plot, aes(x = cyto_time, y = value_log, fill = Outcomes)) +
    geom_boxplot(position = position_dodge(0.7), width = 0.6) +
    labs(
      title = paste("Association between", cytokine_name, "and outcomes"),
      x = "Times of measurement",
      y = paste("Log of", cytokine_name)
    ) +
    geom_text(data = count_data, aes(
      x = cyto_time,
      y = -min(data_plot$value_log, na.rm = TRUE) * 0.01,
      label = paste0("n=", n),
      group = Outcomes
    ), position = position_dodge(0.7), size = 4, vjust = 1) +
    scale_x_discrete(labels = setNames(
  c("implantation", "day 3 to 5", "explantation"),
  c(col_J0, col_J3_J5, col_JS)
)) +
    scale_fill_manual(values = c(
      "ECMO Weaning" = "#4DAF4A",
      "Bridge to transplant or LVAD" = "#377EB8",
      "Death" = "#F8766D"
    )) +
    annotate(
      "text",
      x = 1,
      y = max(data_plot$value_log, na.rm = TRUE) * 1.1,
      label = paste0("p[time]: ", p_time, " p[outcomes]: ", p_outcome),
      parse = FALSE,
      size = 4,
      hjust = 0
    )

  print(p)
}
```

# IL-6

```{r}
plot_cytokine(df, "IL6")
```

# IL-5

```{r}
plot_cytokine(df, "IL5")
```

Among the cytokines measured, IL-5 concentrations appeared lower in patients successfully weaned from ECMO, although differences across timepoints and outcomes did not reach statistical significance.

# IL-8

```{r}
plot_cytokine(df, "IL8/CXCL8")
```

Also IL-8 concentrations appeared clear lower in patients successfully weaned from ECMO, although differences across timepoints and outcomes did not reach statistical significance.

# IL-10

```{r}
plot_cytokine(df, "IL10")

df$IL10_JS

```

IL-10 levels showed a statistically significant change over time (p < 0.05), indicating dynamic modulation during the clinical course. However, no significant differences were observed across the defined outcome groups. 

# GDF-15

```{r}
plot_cytokine(df, "GDF-15")
```

GDF-15 concentrations appeared lower in patients successfully weaned from ECMO, although differences across timepoints and outcomes did not reach statistical significance.
